<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width" />

  <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/global.css}">
  <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/calendar/calendar.css}" />
  <link
          rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap"
  />
  <link
          rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Rubik:wght@400&display=swap"
  />
</head>
<body>
<div class="div37">
  <div class="line34"></div>
  <div class="image-11"></div>
  <div class="inner">
    <header class="frame-header">
      <div class="frame-wrapper6">
        <div class="frame-parent7">
          <div class="icon-parent2">
            <img
                    class="icon23"
                    loading="lazy"
                    alt=""
                    src="/images/icon@2x.png"
            />

            <div class="constructor-wrapper">
              <a class="constructor1" href="/SimplePsy/V1/session/calendar">Понятная практика</a>
            </div>
            <div class="icon-parent3">
              <img
                      class="icon24"
                      loading="lazy"
                      alt=""
                      src="/images/icon-1@2x.png"
              />
              <input type="hidden" id="currentSpecialistId" th:value="${specialist.id}">
              <div class="search-input">
                <input type="text" class="search1" placeholder="Найти клиента..." list="customerList" id="customerSearch" autocomplete="off">
                <datalist id="customerList">

                </datalist>

              </div>
            </div>
          </div>
          <div class="main-area-inner">
            <div class="about-us-parent4">
              <a class="about-us16">Добавить клиента</a>
              <a class="news10">Назначить встречу</a>
              <a class="user-policy10">Добавить график нерабочих дней </a>
            </div>
          </div>
        </div>
      </div>
      <div class="icon-parent4">
        <img
                class="icon25"
                loading="lazy"
                alt=""
                src="/images/icon-2@2x.png"
        />

        <div class="location-name1">
          <b th:text="${specialist.city}" class="specialist-city"></b>
        </div>
      </div>
    </header>
  </div>
  <main class="frame-main">
    <div class="frame-wrapper7">
      <div class="frame-parent8">
        <div class="frame-wrapper8">
          <div class="settings-parent">
            <img
                    class="settings-icon"
                    loading="lazy"
                    alt=""
                    src="/images/settings@2x.png"
            />

            <div class="user-button">
              <div class="wrapper-user1">
                <img
                        class="user-icon"
                        loading="lazy"
                        alt=""
                        th:src="@{'/SimplePsy/V1/specialist/avatar/' + ${specialist.id}}"
                        id="userImage"
                        onclick="window.location.href='/SimplePsy/V1/specialist/personal-info'"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="frame-wrapper9">
          <div class="frame-parent9">
            <div class="hello-wrapper">
              <b class="hello">Привет, </b>
              <b th:text="${specialist.name}" class="hello" ></b>
              <b class="hello">!</b>
            </div>
            <b class="specialist-email">
              <p th:text="${specialist.username}" class="specialist-email-content"></p>
            </b>
          </div>
        </div>
        <div class="frame-parent10">
          <div class="frame-wrapper73">
            <div class="frame-parent122">
              <div class="frame-parent123">
                <div class="client-list-wrapper">
                  <button class="base90" onclick="window.location.href='/SimplePsy/V1/specialist/customers';"></button>
                  <div class="icon-wrapper33">
                    <img class="icon146" alt="" src="/images/icon-3@2x.png" />
                  </div>
                  <b class="client-list fix-font-size">Список клиентов</b>
                </div>
                <div class="base-frame">
                  <button class="calendar-wrapper" id="baseContainer" onclick="window.location.href='/SimplePsy/V1/session/calendar';">
                    <div class="icon-wrapper34">
                      <img class="icon147" alt="" src="/images/icon-41@2x.png"/>
                    </div>
                    <b class="calendar-navigation fix-font-size">Календарь</b>
                  </button>
                </div>
              </div>
              <div class="frame-parent123">
                <div class="notifications-wrapper">
                  <button class="base90 fix-angle-base90" onclick="alert('Эта кнопка находится в разработке')"></button>
                  <div class="icon-wrapper33">
                    <img class="icon146" alt="" src="/images/icon-5.svg" />
                  </div>
                  <b class="notifications fix-font-size">Уведомления</b>
                </div>
                <div class="base-frame">
                  <button class="calendar-wrapper" id="baseContainer" onclick="alert('Эта кнопка находится в разработке')">
                    <div class="icon-wrapper34">
                      <img class="icon147" alt="" src="/images/icon-6.svg"/>
                    </div>
                    <b class="analytics fix-font-size">Аналитика</b>
                  </button>
                </div>
                <div class="tests-wrapper">
                  <button class="base94" onclick="window.location.href='/SimplePsy/V1/scoring/list';"></button>
                  <b class="surveys-tests fix-font-size">Опросники и тесты</b>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="feedback-item">
          <div class="feedback-button">
            <img
                    class="icon30"
                    loading="lazy"
                    alt=""
                    src="/images/icon-7@2x.png"
            />

            <div class="frame-parent13" onclick="alert('Эта кнопка находится в разработке')">
              <div class="send-feedback-container">
                <b class="send-feedback1">Обратная связь</b>
              </div>
              <img
                      class="icon31"
                      loading="lazy"
                      alt=""
                      src="/images/icon-8.svg"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
    <section class="now-parent">

      <div class="base-parent2">
        <div class="calendar">
          <div class="header">
            <div class="view-buttons">
              <button id="dayBtn" class="button-L" >День</button>
              <button id="weekBtn" class="button-C" >Неделя</button>
              <button id="monthBtn" class="button-R">Месяц</button>
            </div>
            <div class="month-year">
              <button id="prevBtn">&lt;</button>
              <div id="viewMode"></div>
              <button id="nextBtn">&gt;</button>
            </div>
          </div>

          <div id="days-of-week">
            <b>ПН</b>
            <b>ВТ</b>
            <b>СР</b>
            <b>ЧТ</b>
            <b>ПТ</b>
            <b>СБ</b>
            <b>ВС</b>
          </div>

          <div id="calendarBody" class="month-view grid">

          </div>
          <script th:inline="javascript">
            // Передача данных о сессиях из Thymeleaf в JavaScript
            let sessionsData = /*[[${meetings}]]*/ [];
          </script>
        </div>
      </div>
    </section>
  </main>
</div>
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>
<script defer>
  document.addEventListener('DOMContentLoaded', function() {
    const calendarBody = document.getElementById('calendarBody');
    const viewModeElem = document.getElementById('viewMode');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const dayBtn = document.getElementById('dayBtn');
    const weekBtn = document.getElementById('weekBtn');
    const monthBtn = document.getElementById('monthBtn');

    let currentDate = new Date();
    let currentViewMode = 'month'; // month, week, day
    let eventsData = []; // Массив для хранения данных о событиях

    // Генерация нескольких событий
    generateEvents();

    renderCalendar(currentDate);

    function renderCalendar(date) {
      calendarBody.innerHTML = ''; // Очищаем предыдущее содержимое

      switch (currentViewMode) {
        case 'month':
          calendarBody.classList.add('grid');
          renderMonthView(date);
          break;
        case 'week':
          calendarBody.classList.add('grid');
          renderWeekView(date);
          break;
        case 'day':
          calendarBody.classList.remove('grid');
          renderDayView(date);
          let sessions = document.querySelectorAll('.session');
          if (sessions) {
            sessions.forEach((session) => session.addEventListener("click", function (e) {
              let sessionId = e.target.id;
              window.location.href = "/SimplePsy/V1/session/report/" + sessionId;
            }))

          }
          break;
        default:
          renderMonthView(date);
          break;
      }

      viewModeElem.textContent = getViewModeTitle(date);
      disableActiveModeButton();
    }

    function getViewModeTitle(date) {
      switch (currentViewMode) {
        case 'month':
          return date.toLocaleString('default', { month: 'long', year: 'numeric' });
        case 'week':
          let startOfWeek = getStartOfWeek(date);
          let endOfWeek = getEndOfWeek(date);
          return `${startOfWeek.getDate()} ${startOfWeek.toLocaleString('default', { month: 'short' })} - ${endOfWeek.getDate()} ${endOfWeek.toLocaleString('default', { month: 'short' })}, ${startOfWeek.getFullYear()}`;
        case 'day':
          return date.toLocaleString('default', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        default:
          return '';
      }
    }

    function renderMonthView(date) {
      const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
      const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
      const daysInMonth = endOfMonth.getDate();

      // Преобразуем день недели так, чтобы неделя начиналась с понедельника
      let startDay = startOfMonth.getDay();
      startDay = startDay === 0 ? 6 : startDay - 1; // Если это воскресенье (0), начинаем с понедельника (6), иначе смещаем на 1

      // Добавляем пустые ячейки до первого дня месяца
      for (let i = 0; i < startDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.classList.add('day');
        calendarBody.appendChild(emptyCell);
      }

      // Добавляем ячейки с днями месяца
      for (let i = 1; i <= daysInMonth; i++) {
        const day = new Date(date.getFullYear(), date.getMonth(), i);
        const dayElement = createDayElement(day);

        // Отображаем события (сессии) для дня
        const sessionsForDay = sessionsData.filter(session => isSameDay(new Date(session.date), day));
        if (sessionsForDay.length > 0) {
          sessionsForDay.forEach(session => {
            const sessionElement = document.createElement('div');
            sessionElement.classList.add('session');
            switch (session.customer.typeOfClient) {
              case 'ADULT':
                sessionElement.textContent = `${session.timeStart} - ${session.timeFinish}: ${session.customer.name} ${session.customer.surname}`;
                break;
              case 'CHILD':
                sessionElement.textContent = `${session.timeStart} - ${session.timeFinish}: ${session.customer.childName} ${session.customer.childSurname}`;
                break;
              case 'COUPLE':
                sessionElement.textContent = `${session.timeStart} - ${session.timeFinish}: ${session.customer.firstClientName} ${session.customer.firstClientSurname}`;
                break;
              default:
                // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                console.log('Unknown client type');
                break;
            }
            dayElement.appendChild(sessionElement);
          });
        }

        calendarBody.appendChild(dayElement);
      }
    }

    function isSameDay(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
              date1.getMonth() === date2.getMonth() &&
              date1.getDate() === date2.getDate();
    }

    function isSameHour(date1, date2, hour) {
      return isSameDay(date1, date2) && date1.getHours() === hour;
    }


    function renderWeekView(date) {
      const startOfWeek = getStartOfWeek(date);

      for (let i = 0; i < 7; i++) {
        const day = new Date(startOfWeek.getFullYear(), startOfWeek.getMonth(), startOfWeek.getDate() + i);
        const dayElement = createDayElement(day);

        const sessionsForDay = sessionsData.filter(session => isSameDay(new Date(session.date), day));
        if (sessionsForDay.length > 0) {
          sessionsForDay.forEach(session => {
            const sessionElement = document.createElement('div');
            sessionElement.classList.add('session');
            switch (session.customer.typeOfClient) {
              case 'ADULT':
                sessionElement.textContent = `${session.timeStart} - ${session.timeFinish}: ${session.customer.name} ${session.customer.surname}`;
                break;
              case 'CHILD':
                sessionElement.textContent = `${session.timeStart} - ${session.timeFinish}: ${session.customer.childName} ${session.customer.childSurname}`;
                break;
              case 'COUPLE':
                sessionElement.textContent = `${session.timeStart} - ${session.timeFinish}: ${session.customer.firstClientName} ${session.customer.firstClientSurname}`;
                break;
              default:
                // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                console.log('Unknown client type');
                break;
            }
            dayElement.appendChild(sessionElement);
          });
        }

        calendarBody.appendChild(dayElement);
      }
    }

    function renderDayView(date) {
      const dayView = document.createElement('div');
      dayView.classList.add('day-view');

      for (let hour = 0; hour < 24; hour++) {
        const hourElement = document.createElement('div');
        hourElement.classList.add('hour');
        hourElement.textContent = `${hour}:00`;

        const sessionsForHour = sessionsData.filter(session => {
          const sessionStart = new Date(session.date + 'T' + session.timeStart);
          const sessionEnd = new Date(session.date + 'T' + session.timeFinish);

          // Проверяем, попадает ли час в диапазон времени встречи и соответствует ли дата
          return (
                  sessionStart.getFullYear() === date.getFullYear() &&
                  sessionStart.getMonth() === date.getMonth() &&
                  sessionStart.getDate() === date.getDate() &&
                  (hour >= sessionStart.getHours() && hour <= sessionEnd.getHours())
          );
        });

        if (sessionsForHour.length > 0) {
          sessionsForHour.forEach(session => {
            const sessionElement = document.createElement('div');
            sessionElement.classList.add('session');
            sessionElement.classList.add('session-day');
            sessionElement.setAttribute('id', session.id);
            switch (session.customer.typeOfClient) {
              case 'ADULT':
                sessionElement.textContent = `${session.customer.name} ${session.customer.surname} (${session.timeStart} - ${session.timeFinish})`;
                break;
              case 'CHILD':
                sessionElement.textContent = `${session.customer.childName} ${session.customer.childSurname} (${session.timeStart} - ${session.timeFinish})`;
                break;
              case 'COUPLE':
                sessionElement.textContent = `${session.customer.firstClientName} ${session.customer.firstClientSurname} (${session.timeStart} - ${session.timeFinish})`;
                break;
              default:
                // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                console.log('Unknown client type');
                break;
            }
            hourElement.appendChild(sessionElement);
          });
        }

        dayView.appendChild(hourElement);
      }

      calendarBody.appendChild(dayView);
    }

    function createDayElement(date) {
      const dayElement = document.createElement('div');
      dayElement.classList.add('day');
      dayElement.textContent = date.getDate();

      // Add event listeners to switch to day view
      dayElement.addEventListener('click', function() {
        currentViewMode = 'day';
        currentDate = date; // Устанавливаем текущую дату на выбранный день
        renderCalendar(currentDate);
      });

      // Simulate events for demonstration
      const eventsForDay = eventsData.filter(event => isSameDay(event.date, date));
      if (eventsForDay.length > 0) {
        const eventsIndicator = document.createElement('div');
        eventsIndicator.classList.add('events');
        eventsIndicator.textContent = `${eventsForDay.length} события`;
        dayElement.appendChild(eventsIndicator);
      }

      return dayElement;
    }

    function getStartOfWeek(date) {
      const startOfWeek = new Date(date);
      const dayOfWeek = startOfWeek.getDay();
      const diff = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek; // Смещаем дни так, чтобы понедельник был первым
      startOfWeek.setDate(date.getDate() + diff);
      return startOfWeek;
    }

    function getEndOfWeek(date) {
      const endOfWeek = new Date(date);
      const dayOfWeek = endOfWeek.getDay();
      const diff = (dayOfWeek === 0 ? 0 : 7) - dayOfWeek; // Добавляем дни до конца недели (воскресенье)
      endOfWeek.setDate(date.getDate() + diff);
      return endOfWeek;
    }

    function disableActiveModeButton() {
      dayBtn.disabled = currentViewMode === 'day';
      weekBtn.disabled = currentViewMode === 'week';
      monthBtn.disabled = currentViewMode === 'month';
    }

    function generateEvents() {

    }

    function isSameDay(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
              date1.getMonth() === date2.getMonth() &&
              date1.getDate() === date2.getDate();
    }

    function isSameHour(date1, date2, hour) {
      return isSameDay(date1, date2) && date1.getHours() === hour;
    }

    function formatTime(date) {
      return `${padZero(date.getHours())}:${padZero(date.getMinutes())}`;
    }

    function padZero(num) {
      return num.toString().padStart(2, '0');
    }

    prevBtn.addEventListener('click', function() {
      switch (currentViewMode) {
        case 'month':
          currentDate.setMonth(currentDate.getMonth() - 1);
          break;
        case 'week':
          currentDate.setDate(currentDate.getDate() - 7);
          break;
        case 'day':
          currentDate.setDate(currentDate.getDate() - 1);
          break;
        default:
          break;
      }
      renderCalendar(currentDate);
    });

    nextBtn.addEventListener('click', function() {
      switch (currentViewMode) {
        case 'month':
          currentDate.setMonth(currentDate.getMonth() + 1);
          break;
        case 'week':
          currentDate.setDate(currentDate.getDate() + 7);
          break;
        case 'day':
          currentDate.setDate(currentDate.getDate() + 1);
          break;
        default:
          break;
      }
      renderCalendar(currentDate);
    });

    dayBtn.addEventListener('click', function() {
      currentViewMode = 'day';
      document.getElementById('days-of-week').style.display = 'none';
      renderCalendar(currentDate);
    });

    weekBtn.addEventListener('click', function() {
      currentViewMode = 'week';
      document.getElementById('days-of-week').style.display = 'flex';
      renderCalendar(currentDate);
    });

    monthBtn.addEventListener('click', function() {
      currentViewMode = 'month';
      document.getElementById('days-of-week').style.display = 'flex';
      renderCalendar(currentDate);
    });
  });

  // Открытие модального окна создания сессии
  document.addEventListener('DOMContentLoaded', function() {
    // Получаем элементы
    var modal = document.getElementById('modal');
    var modalBody = document.getElementById('modal-body');
    var closeBtn = document.querySelector('.close-btn');
    var appointLink = document.querySelector('.news10'); // Элемент "Назначить встречу"
    var holidayBtn = document.querySelector('.user-policy10');
    var addCustomer = document.querySelector('.about-us16');

    // Функция для открытия модального окна
    function openModal() {
      fetch('/SimplePsy/V1/session/session-form')
              .then(response => response.text())
              .then(data => {
                modalBody.innerHTML = data;
                modal.style.display = 'block';
              })
              .catch(error => console.error('Ошибка загрузки:', error));

      fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
              .then(response => response.json())
              .then(clients => {
                const dataList = document.getElementById('clientsList');
                dataList.innerHTML = '';

                const script = document.createElement('script');
                script.id = 'dynamic-script';
                script.textContent = `
  document.getElementById('clientInput').addEventListener('change', function() {
    const selectedOption = Array.from(document.getElementById('clientsList').options).find(option => option.value === this.value);
    if (selectedOption) {
      const clientId = selectedOption.getAttribute('data-id');
      document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
    }
  });
  // Функция для валидации формы
  function validateForm() {
    const clientId = document.getElementById('clientId').value;
    if (!clientId) {
      document.getElementById('error-message').style.display = 'block'; // Показываем сообщение об ошибке
      return false; // Отменяем отправку формы
    }
    return true; // Разрешаем отправку формы, если значение есть
  }

  document.getElementById('clientInput').addEventListener('change', function() {
    const selectedOption = Array.from(document.getElementById('clientsList').options)
            .find(option => option.value === this.value);
    if (selectedOption) {
      const clientId = selectedOption.getAttribute('data-id');
      document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
      document.getElementById('error-message').style.display = 'none'; // Скрываем сообщение об ошибке при успешном выборе клиента
    } else {
      document.getElementById('clientId').value = ''; // Очищаем скрытое поле, если выбранного клиента нет в списке
    }
  });`;
                document.body.appendChild(script);
                clients.forEach(customer => {
                  const option = document.createElement('option');
                  switch (customer.typeOfClient) {
                    case 'ADULT':
                      option.value = customer.name + ' ' + customer.surname;
                      break;
                    case 'CHILD':
                      option.value = customer.childName + ' ' + customer.childSurname;
                      break;
                    case 'COUPLE':
                      option.value = customer.firstClientName + ' ' + customer.firstClientSurname;
                      break;
                    default:
                      // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                      console.log('Unknown client type');
                      break;
                  }
                  option.setAttribute('data-id', customer.id);
                  dataList.appendChild(option);
                });
              })
              .catch(error => console.error('Ошибка:', error));
    }
    function openAddClientModal()
    {
      document.body.style.overflow = 'hidden';
      fetch('/SimplePsy/V1/customer/customer/create/modal')
              .then(response => response.text())
              .then(html => {
                modalBody.innerHTML = html;
                modal.style.display = "block";

                // Добавляем обработчик закрытия модального окна
                document.querySelector('.close-modal').onclick = function() {
                  modal.style.display = "none";
                };
              })
              .catch(error => {
                console.error('Error loading modal content:', error);
              });
    }
    // Функция для закрытия модального окна
    function closeModal() {
      modal.style.display = 'none';
      const script = document.getElementById('dynamic-script');
      if (script) {
        script.remove();
        console.log('Скрипт удалён');
      } else {
        console.log('Скрипт не найден');
      }
    }

    appointLink.addEventListener('click', openModal);
    holidayBtn.addEventListener('click', openHolidayModal);
    addCustomer.addEventListener('click', openAddClientModal);


    closeBtn.addEventListener('click', closeModal);
  });

  function openHolidayModal()
  {
    const modal = document.getElementById("modal");
    const modalBody = document.getElementById("modal-body");

    fetch('/SimplePsy/V1/session/holiday')
            .then(response => response.text())
            .then(html => {
              modalBody.innerHTML = html;
              modal.style.display = "block";

              // Добавляем обработчик закрытия модального окна
              document.querySelector('.close-modal').onclick = function() {
                modal.style.display = "none";
              };
            })
            .catch(error => {
              console.error('Error loading modal content:', error);
            });
  }
  const customerSearch = document.getElementById('customerSearch');
  const currentSpecialistId = document.getElementById('currentSpecialistId').value;

  customerSearch.addEventListener('input', function () {
    const searchQuery = this.value;
    const datalist = document.getElementById('customerList');

    if (searchQuery.length > 1) { // Минимум 2 символа для отправки запроса
      fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
              .then(response => response.json())
              .then(data => {
                // Очищаем предыдущие результаты
                datalist.innerHTML = '';

                // Фильтруем и сортируем клиентов в зависимости от типа
                data.forEach(customer => {
                  let displayName = '';
                  if (customer.typeOfClient === 'ADULT') {
                    displayName = `${customer.name} ${customer.surname}`;
                  } else if (customer.typeOfClient === 'CHILD') {
                    displayName = `${customer.childName} ${customer.childSurname}`;
                  } else if (customer.typeOfClient === 'COUPLE') {
                    displayName = `${customer.firstClientName} ${customer.firstClientSurname}`;
                  }

                  if (displayName.toLowerCase().includes(searchQuery.toLowerCase())) {
                    const option = document.createElement('option');
                    option.value = displayName;
                    option.dataset.id = customer.id;
                    datalist.appendChild(option);
                  }
                });
              })
              .catch(error => {
                console.error('Ошибка при загрузке данных клиентов:', error);
              });
    }
  });

  customerSearch.addEventListener('change', function () {
    const selectedOption = Array.from(document.querySelectorAll('#customerList option'))
            .find(option => option.value === customerSearch.value);

    if (selectedOption) {
      const customerId = selectedOption.dataset.id;
      window.location.href = `/SimplePsy/V1/customer/customer-card/${customerId}`; // Передача username через GET-параметр
    }
  });
</script>
</body>
</html>
