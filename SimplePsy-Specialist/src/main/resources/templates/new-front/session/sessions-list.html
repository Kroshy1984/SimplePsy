<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/global.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/session/sessions-list.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/session/projective-modal.css}" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Rubik:wght@400&display=swap"
    />
  </head>
  <body>
  <div class="div73">
    <div class="settings1"></div>
    <header class="frame-parent60">
      <div class="frame-wrapper40">
        <div class="frame-parent61">
          <div class="icon-parent14">
            <img
                    class="icon72"
                    loading="lazy"
                    alt=""
                    src="/images/icon@2x.png"
            />

            <div class="constructor-wrapper1">
              <a class="constructor6" href="/SimplePsy/V1/session/calendar">Понятная практика</a>
            </div>
            <div class="icon-parent15">
              <img class="icon73" alt="" src="/images/icon-1@2x.png" />
              <input type="hidden" id="currentSpecialistId" th:value="${specialist.id}">
              <div class="search-input">
                <input type="text" class="search1" placeholder="Найти клиента..." list="customerList" id="customerSearch" autocomplete="off">
                <datalist id="customerList">

                </datalist>
              </div>
            </div>
          </div>
          <div class="frame-wrapper41">
            <div class="about-us-group">
              <a class="about-us6">Добавить клиента</a>
              <div class="news-parent">
                <a class="news10">Назначить встречу</a>
                <b class="user-policy6">Добавить график нерабочих дней </b>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="icon-parent16">
        <img class="icon74" alt="" src="/images/icon-2@2x.png" />

        <div class="new-york-wrapper1">
          <b th:text="${specialist.city}" class="specialist-city"></b>
        </div>
      </div>
    </header>
    <div class="item35">
      <img class="feather-icon-chevron-up5" alt="" />
    </div>
    <section class="frame-parent62">
      <div class="frame-wrapper42">
        <div class="frame-parent63">
          <div class="wrapper-user-frame">
            <div class="wrapper-user6">
              <img
                      class="user-icon"
                      loading="lazy"
                      alt=""
                      th:src="@{'/SimplePsy/V1/specialist/avatar/' + ${specialist.id}}"
                      id="userImage"
                      onclick="window.location.href='/SimplePsy/V1/specialist/personal-info'"
              />
            </div>
          </div>
          <div class="frame-wrapper43">
            <div class="frame-parent64">
              <div class="hello-wrapper">
                <b class="hello">Привет, </b>
                <b th:text="${specialist.name}" class="hello" ></b>
                <b class="hello">!</b>
              </div>
              <b class="specialist-email">
                <p th:text="${specialist.username}" class="specialist-email-content"></p>
              </b>
            </div>
          </div>
          <div class="frame-wrapper73">
            <div class="frame-parent122">
              <div class="frame-parent123">
                <div class="client-list-wrapper">
                  <button class="base90" onclick="window.location.href='/SimplePsy/V1/specialist/customers';"></button>
                  <div class="icon-wrapper33">
                    <img class="icon146" alt="" src="/images/icon-3@2x.png" />
                  </div>
                  <b class="client-list">Список клиентов</b>
                </div>
                <div class="base-frame">
                  <button class="calendar-wrapper" id="baseContainer" onclick="window.location.href='/SimplePsy/V1/session/calendar';">
                    <div class="icon-wrapper34">
                      <img class="icon147" alt="" src="/images/icon-41@2x.png"/>
                    </div>
                    <b class="calendar">Календарь</b>
                  </button>
                </div>
              </div>
              <div class="frame-parent123">
                <div class="notifications-wrapper">
                  <button class="base90 fix-angle-base90" onclick="alert('Эта кнопка находится в разработке')"></button>
                  <div class="icon-wrapper33">
                    <img class="icon146" alt="" src="/images/icon-5.svg" />
                  </div>
                  <b class="notifications">Уведомления</b>
                </div>
                <div class="base-frame">
                  <button class="calendar-wrapper" id="baseContainer" onclick="alert('Эта кнопка находится в разработке')">
                    <div class="icon-wrapper34">
                      <img class="icon147" alt="" src="/images/icon-6.svg"/>
                    </div>
                    <b class="analytics">Аналитика</b>
                  </button>
                </div>
                <div class="tests-wrapper">
                  <button class="base94" onclick="window.location.href='/SimplePsy/V1/scoring/list';"></button>
                  <b class="surveys-tests">Опросники и тесты</b>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="frame-parent66">
        <div class="frame-parent67">
          <div class="frame-parent68">
            <button class="rectangle-parent52" onclick="window.location.href='/SimplePsy/V1/specialist/customers';">
              <div class="frame-child69"></div>
              <div class="div74">Список клиентов</div>
            </button>
            <button class="rectangle-parent53" onclick="window.location.href='/SimplePsy/V1/session/sessions';">
              <div class="frame-child56"></div>
              <div class="div75">Список встреч</div>
            </button>
            <button class="rectangle-parent52" id="groupButton" onclick="window.location.href='/SimplePsy/V1/scoring/list';">
              <div class="frame-child55"></div>
              <div class="div74">Опросники и тесты</div>
            </button>
          </div>
          <div class="component-19-wrapper">
            <div class="component-19">
              <div class="rectangle-parent54" th:each="newSession:${sessions}" th:data-card-id="${newSession.id}" onclick="goTo(this)">
                <div class="frame-child57"></div>
                <div class="frame-child58"></div>
                <b class="b82" th:text="${newSession.date}"></b>
                <div class="wrapper22"  th:switch="${newSession.customer.typeOfClient}" th:value="${newSession.customer.typeOfClient}">
                  <b class="b83" th:case="${newSession.customer.typeOfClient.ADULT}" th:text="${newSession.customer.surname + ' ' + newSession.customer.name }"></b>
                  <b class="b83" th:case="${newSession.customer.typeOfClient.COUPLE}" th:text="${newSession.customer.firstClientSurname + ' ' + newSession.customer.firstClientName}"></b>
                  <b class="b83" th:case="${newSession.customer.typeOfClient.CHILD}" th:text="${newSession.customer.childSurname + ' ' + newSession.customer.childName}"></b>
                </div>
                <button class="delete-button" th:data-card-id="${newSession.id}" onclick="deleteSession(this)">x</button>
              </div>
            </div>
          </div>
        </div>
        <div class="frame-parent69">
          <div class="frame-parent70">
            <div class="frame-wrapper46">
              <div class="rectangle-parent61">
                <div class="frame-child70"></div>
                <span>
                    <p class="p31">
                      Контракт и подробные условия оказания психологической
                      помощи
                    </p>
                    <p class="p32">Дата согласия:</p>
                  </span>
              </div>
            </div>
            <div class="frame-wrapper47">
              <div class="frame-parent71">
                <div class="wrapper28">
                  <h2 class="h21">Проективные методики</h2>
                </div>
                <div th:each="meet:${sessions}">
                <div class="frame-parent72" th:each="method:${meet.projectiveMethods}" th:data-card-id="${method.id}" th:data-card="${meet.id}" onclick="openModalProjective(this)">
                  <div class="rectangle-parent62">
                    <div class="frame-child71"></div>
                    <b class="b94" th:text="${method.date}"></b>
                  </div>
                  <div class="rectangle-parent63">
                    <div class="frame-child72"></div>
                    <b class="div76" th:text="${method.name}"></b>
                  </div>
                </div>
                </div>
              </div>
            </div>
          </div>
          <form method="post" th:action="@{/SimplePsy/V1/specialist/personal-info/update-hypotheses}" th:object="${specialist}">
            <div class="frame-wrapper48">
              <div class="frame-parent73">
                <div class="wrapper29">
                  <h3 class="h31">Основные терапевтические гипотезы</h3>
                </div>
                <div class="rectangle-parent64">
                  <textarea th:text="${specialist.hypotheses}" name="hypotheses" class="frame-child73" disabled></textarea>
                  <div class="save-edit-buttons">
                    <button id="cancel" type="button" onclick="cancelButton()" class="rectangle-parent51" style="display: none;">
                      <div class="div72">Отменить</div>
                    </button>
                    <button id="edit" type="button" onclick="showInputs()" class="rectangle-parent51">
                      <div class="div72">Редактировать</div>
                    </button>
                    <button id="save" type="submit" class="rectangle-parent51" style="display: none;">
                      <div class="div72">Сохранить</div>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>
    <div class="image-9"></div>
    <div class="frame-parent74">
      <div class="icon-parent17">
        <img class="icon79" alt="" src="/images/icon-7@2x.png" />

        <div class="frame-parent80" onclick="alert('Эта кнопка находится в разработке')">
          <div class="send-feedback-wrapper4">
            <b class="send-feedback6">Обратная связь</b>
          </div>
          <img class="icon80" alt="" src="/images/icon-8.svg" />
        </div>
      </div>
    </div>
  </div>
  <div id="modal-projective" class="modal-projective">
    <div class="modal-content-projective">
      <span class="close" onclick="closeModalProjective()">&times;</span>
      <h2 id="modal-title"></h2>
      <p id="modal-date" class="modal-date"></p>
      <div id="modal-images" class="image-container"></div>
    </div>
  </div>
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>
  <script>
    function showInputs() {
      // Находим элементы, которые нужно изменить
      var inputsFieldSetToEnable = document.querySelectorAll('textarea');
      var saveButton = document.getElementById('save');
      var editButton = document.getElementById('edit');
      var cancelButton = document.getElementById('cancel');

      // Убираем атрибут disabled у всех найденных элементов
      inputsFieldSetToEnable.forEach(function (input) {
        input.removeAttribute('disabled');
      });

      // Показываем кнопки
      saveButton.style.display = 'inline-block';
      editButton.style.display = 'none';
      cancelButton.style.display = 'inline-block';
    }

    function cancelButton() {
      document.getElementById('cancel').style.display = 'none';
      window.location.href = '/SimplePsy/V1/session/sessions';
    }

    function goTo(obj) {
      window.location.href = "./report/" + obj.getAttribute("data-card-id");
    }

    // Открытие модального окна создания сессии
    document.addEventListener('DOMContentLoaded', function() {
    // Получаем элементы
    var modal = document.getElementById('modal');
    var modalBody = document.getElementById('modal-body');
    var closeBtn = document.querySelector('.close-btn');
    var appointLink = document.querySelector('.news10'); // Элемент "Назначить встречу"
    var holidayBtn = document.querySelector('.user-policy6');
      var addCustomer = document.querySelector('.about-us6');
    // Функция для открытия модального окна
      function openModal() {
        fetch('/SimplePsy/V1/session/session-form')
                .then(response => response.text())
                .then(data => {
                  modalBody.innerHTML = data;
                  modal.style.display = 'block';
                })
                .catch(error => console.error('Ошибка загрузки:', error));

        fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
                .then(response => response.json())
                .then(clients => {
                  const dataList = document.getElementById('clientsList');
                  dataList.innerHTML = '';

                  const script = document.createElement('script');
                  script.id = 'dynamic-script';
                  script.textContent = `
  document.getElementById('clientInput').addEventListener('change', function() {
    const selectedOption = Array.from(document.getElementById('clientsList').options).find(option => option.value === this.value);
    if (selectedOption) {
      const clientId = selectedOption.getAttribute('data-id');
      document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
    }
  });
  // Функция для валидации формы
  function validateForm() {
    const clientId = document.getElementById('clientId').value;
    if (!clientId) {
      document.getElementById('error-message').style.display = 'block'; // Показываем сообщение об ошибке
      return false; // Отменяем отправку формы
    }
    return true; // Разрешаем отправку формы, если значение есть
  }

  document.getElementById('clientInput').addEventListener('change', function() {
    const selectedOption = Array.from(document.getElementById('clientsList').options)
            .find(option => option.value === this.value);
    if (selectedOption) {
      const clientId = selectedOption.getAttribute('data-id');
      document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
      document.getElementById('error-message').style.display = 'none'; // Скрываем сообщение об ошибке при успешном выборе клиента
    } else {
      document.getElementById('clientId').value = ''; // Очищаем скрытое поле, если выбранного клиента нет в списке
    }
  });`;
                  document.body.appendChild(script);
                  clients.forEach(customer => {
                    const option = document.createElement('option');
                    switch (customer.typeOfClient) {
                      case 'ADULT':
                        option.value = customer.name + ' ' +customer.surname;
                        break;
                      case 'CHILD':
                        option.value = customer.childName + ' ' + customer.childSurname;
                        break;
                      case 'COUPLE':
                        option.value = customer.firstClientName + ' ' + customer.firstClientSurname;
                        break;
                      default:
                        // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                        console.log('Unknown client type');
                        break;
                    }
                    option.setAttribute('data-id', customer.id);
                    dataList.appendChild(option);
                  });
                })
                .catch(error => console.error('Ошибка:', error));
      }
      function openAddClientModal()
      {
        document.body.style.overflow = 'hidden';
        fetch('/SimplePsy/V1/customer/customer/create/modal')
                .then(response => response.text())
                .then(html => {
                  modalBody.innerHTML = html;
                  modal.style.display = "block";

                  // Добавляем обработчик закрытия модального окна
                  document.querySelector('.close-modal').onclick = function() {
                    modal.style.display = "none";
                  };
                })
                .catch(error => {
                  console.error('Error loading modal content:', error);
                });
      }
      // Функция для закрытия модального окна
      function closeModal() {
        modal.style.display = 'none';
        const script = document.getElementById('dynamic-script');
        if (script) {
          script.remove();
          console.log('Скрипт удалён');
        } else {
          console.log('Скрипт не найден');
        }
      }

    // Событие клика для открытия модального окна
    appointLink.addEventListener('click', openModal);
    holidayBtn.addEventListener('click', openHolidayModal);
    addCustomer.addEventListener('click', openAddClientModal);
    // Событие клика для закрытия модального окна
    closeBtn.addEventListener('click', closeModal);
    });

    function openHolidayModal()
    {
      const modal = document.getElementById("modal");
      const modalBody = document.getElementById("modal-body");

      fetch('/SimplePsy/V1/session/holiday')
              .then(response => response.text())
              .then(html => {
                modalBody.innerHTML = html;
                modal.style.display = "block";

                // Добавляем обработчик закрытия модального окна
                document.querySelector('.close-modal').onclick = function() {
                  modal.style.display = "none";
                };
              })
              .catch(error => {
                console.error('Error loading modal content:', error);
              });
    }


    window.onclick = function(event) {
      const modal = document.getElementById("holidayModal");
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }
    function deleteSession(obj) {
      event.stopPropagation(); // Чтобы предотвратить переход по клику на карточку

      if (confirm('Вы уверены, что хотите удалить эту сессию?')) {
        fetch(`/SimplePsy/V1/session/delete/` + obj.getAttribute("data-card-id"), {
          method: 'DELETE'
        })
                .then(response => {
                  if (response.ok) {
                    alert('Сессия успешно удалена');
                    window.location.reload(); // Перезагружаем страницу после удаления
                  } else {
                    alert('Ошибка при удалении сессии');
                  }
                })
                .catch(error => console.error('Ошибка при удалении сессии:', error));
      }
    }

    const customerSearch = document.getElementById('customerSearch');
    const currentSpecialistId = document.getElementById('currentSpecialistId').value;

    customerSearch.addEventListener('input', function () {
      const searchQuery = this.value;
      const specialistId = "currentSpecialistId"; // Здесь должно быть реальное значение ID специалиста
      const datalist = document.getElementById('customerList');

      if (searchQuery.length > 1) { // Минимум 2 символа для отправки запроса
        fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
                .then(response => response.json())
                .then(data => {
                  // Очищаем предыдущие результаты
                  datalist.innerHTML = '';

                  // Фильтруем и сортируем клиентов в зависимости от типа
                  data.forEach(customer => {
                    let displayName = '';
                    if (customer.typeOfClient === 'ADULT') {
                      displayName = `${customer.name} ${customer.surname}`;
                    } else if (customer.typeOfClient === 'CHILD') {
                      displayName = `${customer.childName} ${customer.childSurname}`;
                    } else if (customer.typeOfClient === 'COUPLE') {
                      displayName = `${customer.firstClientName} ${customer.firstClientSurname}`;
                    }

                    if (displayName.toLowerCase().includes(searchQuery.toLowerCase())) {
                      const option = document.createElement('option');
                      option.value = displayName;
                      option.dataset.id = customer.id;
                      datalist.appendChild(option);
                    }
                  });
                })
                .catch(error => {
                  console.error('Ошибка при загрузке данных клиентов:', error);
                });
      }
    });

    customerSearch.addEventListener('change', function () {
      const selectedOption = Array.from(document.querySelectorAll('#customerList option'))
              .find(option => option.value === customerSearch.value);

      if (selectedOption) {
        const customerId = selectedOption.dataset.id;
        window.location.href = `/SimplePsy/V1/customer/customer-card/${customerId}`; // Передача username через GET-параметр
      }
    });
    function openModalProjective(obj) {
      document.getElementById('modal-title').textContent = null;
      document.getElementById('modal-date').textContent = null;
      document.getElementById('modal-images').innerHTML = null;
      document.getElementById('modal-projective').style.display = 'block';
      const projectId = obj.getAttribute("data-card-id");
      const sessionId = obj.getAttribute("data-card");

      fetch(`/SimplePsy/V1/session/getProjectiveMethod/${sessionId}/${projectId}`)
              .then(response => response.json())
              .then(data => {

                document.getElementById('modal-title').textContent = data.name;

                const imagesContainer = document.getElementById('modal-images');

                // Добавление новых изображений
                data.images.forEach(image => {
    const imgContainer = document.createElement('div'); // Новый контейнер для изображения и даты
    const imgElement = document.createElement('img');
    const dateElement = document.createElement('p');

    imgElement.src = `data:image/webp;base64,${image.image}`;
    imgElement.classList.add('modal-image');
    imgElement.setAttribute('loading', 'lazy');

    dateElement.textContent = image.date;
    dateElement.classList.add('modal-date');

    // Добавляем изображение и дату в контейнер
    imgContainer.appendChild(imgElement);
    imgContainer.appendChild(dateElement);

    // Добавляем контейнер в основной контейнер изображений
    imagesContainer.appendChild(imgContainer);
});

                // Открытие модального окна
                const modal = document.getElementById('modal-projective');
                modal.style.display = 'block';
              })
              .catch(error => {
                console.error('Ошибка загрузки данных методики:', error);
              });
    }
    function closeModalProjective() {
      const projective = document.getElementById("modal-projective");
      projective.style.display = "none";
    }
    function uploadImages(event) {
event.preventDefault();
      const sessionId = document.querySelector('[data-card]').getAttribute('data-card');
      const projectId = document.querySelector('[data-card-id]').getAttribute('data-card-id');
      console.log(document.querySelector('[data-card]').getAttribute('data-card'))
      console.log(document.querySelector('[data-card-id]').getAttribute('data-card-id'))
      const formData = new FormData(document.getElementById('uploadForm'));

      fetch(`/SimplePsy/V1/session/projective/image/add/${sessionId}/${projectId}`, {
        method: 'POST',
        body: formData
      })
              .then(response => {
                if (response.ok) {
                  return response.json();
                } else {
                  throw new Error('Ошибка при загрузке изображений');
                }
              })
              .then(data => {
                // Обновляем список изображений
                const imageContainer = document.getElementById('modal-images');
                imageContainer.innerHTML = ''; // Очищаем контейнер

                data.images.forEach((image, index) => {
                  const imgElement = document.createElement('img');
                  imgElement.src = `data:image/jpeg;base64,${image}`;
                  imgElement.alt = `Image ${index + 1}`;
                  imgElement.classList.add('modal-image');
                  imageContainer.appendChild(imgElement);
                });
              })
              .catch(error => console.error('Ошибка при загрузке изображений:', error));
    }
  </script>
  </body>
</html>
