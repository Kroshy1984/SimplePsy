<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width" />

  <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/global.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/specialist/specialist-home-page.css}" />
  <link
          rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap"
  />
  <link
          rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Rubik:wght@400&display=swap"
  />
</head>
<body>
<div class="div59">
  <div class="settings"></div>
  <header class="frame-parent47">
    <div class="frame-wrapper29">
      <nav class="frame-nav">
        <div class="icon-parent10">
          <img
                  class="icon63"
                  loading="lazy"
                  alt=""
                  src="/images/icon@2x.png"
          />

          <div class="constructor-frame">
            <a class="constructor5" href="/SimplePsy/V1/session/calendar">Понятная практика</a>
          </div>
          <div class="icon-parent11">
            <img
                    class="icon64"
                    loading="lazy"
                    alt=""
                    src="/images/icon-1@2x.png"
            />
            <input type="hidden" id="currentSpecialistId" th:value="${specialist.id}">
            <div class="search-container">
              <input type="text" class="search1" placeholder="Найти клиента..." list="customerList" id="customerSearch" autocomplete="off">
              <datalist id="customerList">

              </datalist>
            </div>
          </div>
        </div>
        <div class="frame-wrapper30">
          <div class="about-us-parent">
            <b class="about-us5">Добавить клиента</b>
            <b class="news10">Назначить встречу</b>
          </div>
        </div>
        <div class="user-policy-frame">
          <b class="user-policy5">Добавить график нерабочих дней </b>
        </div>
      </nav>
    </div>
    <div class="icon-parent12">
      <img
              class="icon65"
              loading="lazy"
              alt=""
              src="/images/icon-2@2x.png"
      />

      <div class="new-york-frame">
        <b th:text="${specialist.city}" class="specialist-city"></b>
      </div>
    </div>
  </header>
  <form method="post" th:action="@{/SimplePsy/V1/specialist/personal-info/update}" th:object="${specialist}"
        enctype="multipart/form-data">
    <main class="frame-parent48">
      <section class="frame-wrapper31">
        <div class="frame-parent49">
          <div class="frame-wrapper32">
            <div class="wrapper-user-parent">
              <div class="wrapper-user5">
                <img
                        class="user-icon"
                        loading="lazy"
                        alt=""
                        th:src="@{'/SimplePsy/V1/specialist/avatar/' + ${specialist.id}}"
                        onclick="window.location.href='/SimplePsy/V1/specialist/personal-info'"
                />
              </div>
              <div class="frame-parent50">
                <div class="hello-wrapper">
                  <b class="hello">Привет, </b>
                  <b th:text="${specialist.name}" class="hello" ></b>
                  <b class="hello">!</b>
                </div>
                <b class="specialist-email">
                  <p th:text="${specialist.username}" class="specialist-email-content"></p>
                </b>
              </div>
            </div>
          </div>
          <div class="frame-parent51">
            <div class="a998761-62ed-4135-8023-6815850-parent">
              <img
                      id="avatarImg"
                      class="a998761-62ed-4135-8023-6815850-icon"
                      loading="lazy"
                      alt="Аватарка"
                      th:src="@{'/SimplePsy/V1/specialist/avatar/' + ${specialist.id}}"
                      style="cursor: pointer;"
                      onclick="document.getElementById('avatarInput').click();"
              />
              <input type="file" id="avatarInput" accept="image/*" style="display: none;" />
            </div>
            <div class="frame-wrapper33">
              <div class="parent8">
                <input th:value="${specialist.surname}" class="div61" type="text" id="surname"
                       name="surname" placeholder="Фамилия" disabled>
                <input th:value="${specialist.name}" class="div61" type="text" id="name"
                       name="name" placeholder="Имя" disabled>
                <input th:value="${specialist.middleName}" class="div61" type="text" id="middleName"
                       name="middleName" placeholder="Отчество" disabled>
                <div class="div62">
                  <input class="p29" th:value="${specialist.city}" type="text" id="city"
                         name="city" placeholder="Город" disabled>
                </div>
                <div class="div63">
                  <input class="p30" th:value="${specialist.phone}" type="tel" id="phone"
                         name="phone" placeholder="Номер телефона" disabled>
                </div>
                <div class="ponyatpractikagmailcom1">
                  <input class="ponyatpractikagmailcom2" th:value="${specialist.username}" type="email" id="email"
                         name="username" placeholder="Почта" disabled>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="frame-parent52">
        <div class="frame-parent53">
          <div class="frame-wrapper34">
            <div class="dashboard-header-items-parent">
              <div class="frame-wrapper73">
                <div class="frame-parent122">
                  <div class="frame-parent123">
                    <div class="client-list-wrapper">
                      <a class="base90" onclick="window.location.href='/SimplePsy/V1/specialist/customers';"></a>
                      <div class="icon-wrapper33">
                        <img class="icon146" alt="" src="/images/icon-3@2x.png" />
                      </div>
                      <b class="client-list">Список клиентов</b>
                    </div>
                    <div class="base-frame">
                      <a class="calendar-wrapper" id="baseContainer" onclick="window.location.href='/SimplePsy/V1/session/calendar';">
                        <div class="icon-wrapper34">
                          <img class="icon147" alt="" src="/images/icon-41@2x.png"/>
                        </div>
                        <b class="calendar">Календарь</b>
                      </a>
                    </div>
                  </div>
                  <div class="frame-parent123">
                    <div class="notifications-wrapper">
                      <button class="base90 fix-angle-base90" onclick="alert('Эта кнопка находится в разработке')"></button>
                      <div class="icon-wrapper33">
                        <img class="icon146" alt="" src="/images/icon-5.svg" />
                      </div>
                      <b class="notifications">Уведомления</b>
                    </div>
                    <div class="base-frame">
                      <button class="calendar-wrapper" id="baseContainer" onclick="alert('Эта кнопка находится в разработке')">
                        <div class="icon-wrapper34">
                          <img class="icon147" alt="" src="/images/icon-6.svg"/>
                        </div>
                        <b class="analytics">Аналитика</b>
                      </button>
                    </div>
                    <div class="tests-wrapper">
                      <a class="base94" onclick="window.location.href='/SimplePsy/V1/scoring/list';"></a>
                      <b class="surveys-tests">Опросники и тесты</b>
                    </div>
                  </div>
                </div>
              </div>
              <div class="frame-wrapper35">
                <div class="frame-parent54">
                  <div class="wrapper20">
                    <b class="b78">Заявки</b>
                  </div>
                  <div
                          class="applications-header-dividers-parent"
                          id="groupContainer"
                  >
                    <div class="applications-header-dividers">
                      <div class="applications-header-dividers-child"></div>
                      <b class="applications-divider">20.02.2024</b>
                    </div>
                    <div class="rectangle-parent42">
                      <div class="frame-child45"></div>
                      <b class="b79">Овсянникова Юля Матвеевна</b>
                    </div>
                  </div>
                  <div class="frame-parent55" id="groupContainer1">
                    <div class="rectangle-parent43">
                      <div class="frame-child46"></div>
                      <b class="b80">25.02.2024</b>
                    </div>
                    <div class="rectangle-parent44">
                      <div class="frame-child47"></div>
                      <b class="b81">Овсянникова Юля Матвеевна</b>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="frame-parent56">
            <div class="wrapper18">
              <div class="div60">Специализация</div>
            </div>
            <div class="frame-wrapper36">
              <div class="rectangle-parent45">
                <div class="frame-child48"></div>
                <textarea th:text="${specialist.specialization}" name="specialization" class="div65" disabled></textarea>
              </div>
            </div>
            <div class="frame-parent57">
              <div class="wrapper21">
                <div class="div66">
                  Описание профессиональной деятельности
                </div>
              </div>
              <div class="rectangle-parent46">
                <div class="frame-child49"></div>
                <textarea th:text="${specialist.description}" name="description" class="div67" disabled></textarea>
              </div>
            </div>
            <div class="frame-wrapper37">
              <div class="parent9">
                <div class="div68">Образование</div>
                <div class="rectangle-parent47">
                  <div class="frame-child50"></div>
                  <div class="oulu-university-container">
                    <textarea th:text="${specialist.education}" name="education" class="div67" disabled></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="div69">Дипломы</div>
          </div>
        </div>
        <div class="frame-wrapper38">
          <div class="frame-parent58">
            <div class="icon-parent13">
              <img
                      class="icon70"
                      loading="lazy"
                      alt=""
                      src="/images/icon-7@2x.png"
              />

              <div class="frame-parent59" onclick="alert('Эта кнопка находится в разработке')">
                <div class="send-feedback-wrapper3">
                  <b class="send-feedback5">Обратная связь</b>
                </div>
                <img
                        class="icon71"
                        loading="lazy"
                        alt=""
                        src="/images/icon-8.svg"
                />
              </div>
            </div>
            <div class="frame-wrapper39">
              <div class="rectangle-parent48">
                <div class="frame-child51"></div>
                <label for="file-upload" class="rectangle-parent49">+ Добавить фото</label>
                <input id="file-upload" name="diploma" type="file" accept="image/*" multiple>
                <div class="diploma-div" th:each="diploma, iterStat : ${specialist.diplomas}">
                  <a rel="nofollow" target="_blank" th:href="@{'/SimplePsy/V1/specialist/diploma/' + ${specialist.id} + '/' + ${iterStat.index}}">
                    <img th:src="@{'/SimplePsy/V1/specialist/diploma/' + ${specialist.id} + '/' + ${iterStat.index}}"
                         alt="Диплом"
                         th:data-specialist-id="${specialist.id}"
                         th:data-diploma-index="${iterStat.index}"
                         class="diploma-img"/>
                  </a>
                  <!-- Крестик для удаления -->
                  <span style="position: absolute; top: -11px; right: -8px; cursor: pointer; color: red;"
                        class="delete-diploma">
        &times;
    </span>
                </div>



              </div>
            </div>
          </div>
        </div>
        <div class="save-edit-buttons-wrapper">
          <div class="save-edit-buttons">
            <button id="cancel" type="button" onclick="cancelButton()" class="rectangle-parent51" style="display: none;">
              <div class="div72">Отменить</div>
            </button>
            <button id="edit" type="button" onclick="showInputs()" class="rectangle-parent51">
              <div class="div72">Редактировать</div>
            </button>
            <button id="save" type="submit" class="rectangle-parent51" style="display: none;">
              <div class="div72">Сохранить</div>
            </button>
          </div>
        </div>
      </section>
    </main>
  </form>
</div>
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>
<script>
  // Получаем элементы
  var modal = document.getElementById('modal');
  var modalBody = document.getElementById('modal-body');
  var closeBtn = document.querySelector('.close-btn');
  var appointLink = document.querySelector('.news10'); // Элемент "Назначить встречу"
  var holidayBtn = document.querySelector('.user-policy5');

  // Функция для открытия модального окна
  function openModal() {
    fetch('/SimplePsy/V1/session/session-form')
            .then(response => response.text())
            .then(data => {
              modalBody.innerHTML = data;
              modal.style.display = 'block';
            })
            .catch(error => console.error('Ошибка загрузки:', error));
    fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
            .then(response => response.json())
            .then(clients => {
              const dataList = document.getElementById('clientsList');
              dataList.innerHTML = '';

              const script = document.createElement('script');
              script.id = 'dynamic-script';
              script.textContent = `
  document.getElementById('clientInput').addEventListener('change', function() {
    const selectedOption = Array.from(document.getElementById('clientsList').options).find(option => option.value === this.value);
    if (selectedOption) {
      const clientId = selectedOption.getAttribute('data-id');
      document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
    }
  });
  // Функция для валидации формы
  function validateForm() {
    const clientId = document.getElementById('clientId').value;
    if (!clientId) {
      document.getElementById('error-message').style.display = 'block'; // Показываем сообщение об ошибке
      return false; // Отменяем отправку формы
    }
    return true; // Разрешаем отправку формы, если значение есть
  }

  document.getElementById('clientInput').addEventListener('change', function() {
    const selectedOption = Array.from(document.getElementById('clientsList').options)
            .find(option => option.value === this.value);
    if (selectedOption) {
      const clientId = selectedOption.getAttribute('data-id');
      document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
      document.getElementById('error-message').style.display = 'none'; // Скрываем сообщение об ошибке при успешном выборе клиента
    } else {
      document.getElementById('clientId').value = ''; // Очищаем скрытое поле, если выбранного клиента нет в списке
    }
  });`;
              document.body.appendChild(script);
              clients.forEach(customer => {
                const option = document.createElement('option');
                switch (customer.typeOfClient) {
                  case 'ADULT':
                    option.value = customer.name + ' ' +customer.surname;
                    break;
                  case 'CHILD':
                    option.value = customer.childName + ' ' + customer.childSurname;
                    break;
                  case 'COUPLE':
                    option.value = customer.firstClientName + ' ' + customer.firstClientSurname;
                    break;
                  default:
                    // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                    console.log('Unknown client type');
                    break;
                }
                option.setAttribute('data-id', customer.id);
                dataList.appendChild(option);
              });
            })
            .catch(error => console.error('Ошибка:', error));
  }

  // Функция для закрытия модального окна
  function closeModal() {
    modal.style.display = 'none';
  }

  // Событие клика для открытия модального окна
  appointLink.addEventListener('click', openModal);
  holidayBtn.addEventListener('click', openHolidayModal);
  // Событие клика для закрытия модального окна
  closeBtn.addEventListener('click', closeModal);


  var addClientBtn = document.querySelector('.about-us5');
  addClientBtn.addEventListener('click', () =>
  {
    window.location.href = '/SimplePsy/V1/customer/customer-form';
  });

  function openHolidayModal() {
    const modal = document.getElementById("modal");
    const modalBody = document.getElementById("modal-body");

    fetch('/SimplePsy/V1/session/holiday')
            .then(response => response.text())
            .then(html => {
              modalBody.innerHTML = html;
              modal.style.display = "block";

              // Добавляем обработчик закрытия модального окна
              document.querySelector('.close-modal').onclick = function() {
                modal.style.display = "none";
              };
            })
            .catch(error => {
              console.error('Error loading modal content:', error);
            });
  }

  function showInputs() {
    // Находим элементы, которые нужно изменить
    var inputsToEnable = document.querySelectorAll('input[disabled]');
    var inputsFieldSetToEnable = document.querySelectorAll('textarea');
    var saveButton = document.getElementById('save');
    var editButton = document.getElementById('edit');
    var cancelButton = document.getElementById('cancel');

    // Убираем атрибут disabled у всех найденных элементов
    inputsToEnable.forEach(function (input) {
      input.removeAttribute('disabled');
    });
    inputsFieldSetToEnable.forEach(function (input) {
      input.removeAttribute('disabled');
    });

    // Показываем кнопки
    saveButton.style.display = 'inline-block';
    editButton.style.display = 'none';
    cancelButton.style.display = 'inline-block';
  }

  function cancelButton() {
    document.getElementById('cancel').style.display = 'none';
    window.location.href = '/SimplePsy/V1/specialist/personal-info';
  }

  document.getElementById('avatarInput').addEventListener('change', function() {
    var file = this.files[0];
    if (file) {
      var formData = new FormData();
      formData.append('avatar', file);

      fetch('/SimplePsy/V1/specialist/personal-info/avatar', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
              .then(response => response.json()) // предположим, что сервер вернет JSON с обновленным URL аватарки
              .then(data => {
                if (data.success) {
                  // Обновляем изображение аватарки на странице
                  location.reload();
                } else {
                  alert('Ошибка при обновлении аватарки. Попробуйте снова.');
                }
              })
              .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка при обновлении аватарки. Попробуйте снова.');
              });
    }
  });
  document.querySelectorAll('.diploma-img').forEach(function(img) {
    img.addEventListener('click', function() {
      var modal = document.createElement('div');
      modal.classList.add('modal');
      modal.innerHTML = '<img src="' + img.src + '" alt="' + img.alt + '">';
      document.body.appendChild(modal);
      modal.addEventListener('click', function() {
        modal.remove();
      });
    });
  });
  // Функция для удаления диплома
  function deleteDiploma(specialistId, diplomaIndex) {
    if (confirm('Вы уверены, что хотите удалить это изображение?')) {
      fetch(`/SimplePsy/V1/specialist/diploma/` + specialistId + `/` + diplomaIndex, {
        method: 'DELETE', // Метод DELETE, так как это удаление
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
              .then(response => {
                if (response.ok) {
                  // Обновляем страницу или удаляем изображение из DOM
                  location.reload();
                } else {
                  alert('Ошибка при удалении изображения.');
                }
              })
              .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка при удалении изображения.');
              });
    }
  }

  // Привязка события клика к крестикам для удаления
  document.querySelectorAll('.delete-diploma').forEach(span => {
    span.addEventListener('click', function() {
      // Получаем родительский элемент <div>
      const parentDiv = this.closest('div');

      // Получаем ID специалиста и индекс диплома
      const specialistId = parentDiv.querySelector('img').getAttribute('data-specialist-id');
      const diplomaIndex = parentDiv.querySelector('img').getAttribute('data-diploma-index');

      // Вызываем функцию удаления
      deleteDiploma(specialistId, diplomaIndex);
    });
  });
  const customerSearch = document.getElementById('customerSearch');
  const currentSpecialistId = document.getElementById('currentSpecialistId').value;

  customerSearch.addEventListener('input', function () {
    const query = customerSearch.value;

    if (query.length > 2) { // Запрашиваем данные только если введено больше 2 символов
      fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
              .then(response => response.json())
              .then(customers => {
                const filteredCustomers = customers.filter(customer =>
                        customer.name.toLowerCase().includes(query.toLowerCase()) ||
                        customer.surname.toLowerCase().includes(query.toLowerCase())
                );

                const dataList = document.getElementById('customerList');
                dataList.innerHTML = ''; // Очищаем предыдущие результаты

                filteredCustomers.forEach(customer => {
                  const option = document.createElement('option');
                  option.value = `${customer.name} ${customer.surname}`;
                  option.dataset.id = customer.id;
                  dataList.appendChild(option);
                });
              });
    }
  });

  customerSearch.addEventListener('change', function () {
    const selectedOption = Array.from(document.querySelectorAll('#customerList option'))
            .find(option => option.value === customerSearch.value);

    if (selectedOption) {
      const customerId = selectedOption.dataset.id;
      window.location.href = `/SimplePsy/V1/customer/customer-card/${customerId}`; // Передача username через GET-параметр
    }
  });
</script>
</body>
</html>
