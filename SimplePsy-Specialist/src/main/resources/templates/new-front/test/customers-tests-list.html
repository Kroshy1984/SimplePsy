<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/global.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/test/customers-tests-list.css}" />
    <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap"
    />
    <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Rubik:wght@400&display=swap"
    />
</head>
<body>
<style>
    .component-191 ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .component-191 li {
        margin-bottom: 20px;
    }
    .oprosnik {
        position: relative;
        font-size: var(--bold-16-size);
        line-height: 18px;
        font-weight: 700;
        font-family: var(--bold-10);
        color: #5C80FF;
        text-align: center;
        z-index: 1;
    }
    .scoring-item {
        background-color: #f7f7f7;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .scoring-type {
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 10px;
    }

    .buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .button-type {
        background-color: #4CAF50;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
    }

    .button-type:hover {
        background-color: #3e8e41;
    }

    .button {
        background-color: #4CAF50;
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
    }

    .button:hover {
        background-color: #3e8e41;
    }
</style>
<div class="div189">
    <div class="settings4"></div>
    <section class="frame-parent108">
        <div class="navigation-left-parent">
            <div class="navigation-left">
                <div class="navigation-menu1">
                    <div class="navigation-items2">
                        <div class="frame-parent109">
                            <div class="icon-parent26">
                                <img
                                        class="icon134"
                                        loading="lazy"
                                        alt=""
                                        src="/images/icon@2x.png"
                                />

                                <a class="constructor10">Понятная практика</a>
                            </div>
                            <div class="navigation-right">
                                <div class="wrapper-user-parent1">
                                    <div class="wrapper-user10">
                                        <img
                                                class="user-icon"
                                                loading="lazy"
                                                alt=""
                                                th:src="@{'/SimplePsy/V1/specialist/avatar/' + ${specialist.id}}"
                                                id="userImage"
                                                onclick="window.location.href='/SimplePsy/V1/specialist/personal-info'"
                                        />
                                    </div>
                                    <div class="user-info1">
                                        <div class="hello-wrapper">
                                            <b class="hello">Привет, </b>
                                            <b th:text="${specialist.name}" class="hello" ></b>
                                            <b class="hello">!</b>
                                        </div>
                                        <b class="specialist-email">
                                            <p th:text="${specialist.username}" class="specialist-email-content"></p>
                                        </b>
                                    </div>
                                </div>
                            </div>
                            <div class="frame-wrapper73">
                                <div class="frame-parent122">
                                    <div class="frame-parent123">
                                        <div class="client-list-wrapper">
                                            <button class="base90" onclick="window.location.href='/SimplePsy/V1/specialist/customers';"></button>
                                            <div class="icon-wrapper33">
                                                <img class="icon146" alt="" src="/images/icon-3@2x.png" />
                                            </div>
                                            <b class="client-list">Список клиентов</b>
                                        </div>
                                        <div class="base-frame">
                                            <button class="calendar-wrapper" id="baseContainer" onclick="window.location.href='/SimplePsy/V1/session/calendar';">
                                                <div class="icon-wrapper34">
                                                    <img class="icon147" alt="" src="/images/icon-41@2x.png"/>
                                                </div>
                                                <b class="calendar">Календарь</b>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="frame-parent123">
                                        <div class="notifications-wrapper">
                                            <button class="base90 fix-angle-base90" onclick="alert('Эта кнопка находится в разработке')"></button>
                                            <div class="icon-wrapper33">
                                                <img class="icon146" alt="" src="/images/icon-5.svg" />
                                            </div>
                                            <b class="notifications">Уведомления</b>
                                        </div>
                                        <div class="base-frame">
                                            <button class="calendar-wrapper" id="baseContainer" onclick="alert('Эта кнопка находится в разработке')">
                                                <div class="icon-wrapper34">
                                                    <img class="icon147" alt="" src="/images/icon-6.svg"/>
                                                </div>
                                                <b class="analytics">Аналитика</b>
                                            </button>
                                        </div>
                                        <div class="tests-wrapper">
                                            <button class="base94" onclick="window.location.href='/SimplePsy/V1/scoring/list';"></button>
                                            <b class="surveys-tests">Опросники и тесты</b>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="notification-icon">
                        <img class="icon139" alt="" src="/images/icon-1@2x.png" />
                    </div>
                    <div class="search-bar">
                        <div class="search-input4">
                            <nav class="search-input-container">
                                <div class="search-input-field">
                                    <b class="search11">Найти клиента...</b>
                                </div>
                                <div class="search-options">
                                    <div class="search-dropdown">
                                        <div class="search-dropdown-items">
                                            <a class="about-us17">Добавить клиента</a>
                                            <div class="policy-items">
                                                <a class="news10">Назначить встречу</a>
                                                <b class="user-policy11">Добавить график нерабочих дней</b>
                                            </div>
                                        </div>
                                        <div class="frame-parent110">
                                            <button class="rectangle-parent99" onclick="window.location.href='/SimplePsy/V1/specialist/customers';">
                                                <div class="frame-child125"></div>
                                                <div class="div191">Список клиентов</div>
                                            </button>
                                            <button class="rectangle-parent100" onclick="window.location.href='/SimplePsy/V1/session/sessions';">
                                                <div class="frame-child126"></div>
                                                <div class="div192">Список встреч</div>
                                            </button>
                                            <div class="rectangle-parent101" onclick="window.location.href='/SimplePsy/V1/scoring/list';">
                                                <div class="frame-child127"></div>
                                                <h3 class="h33">Опросники и тесты</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="location1">
                                    <img
                                            class="icon140"
                                            alt=""
                                            src="/images/icon-2@2x.png"
                                    />

                                    <div class="location-name2">
                                        <b th:text="${specialist.city}" class="specialist-city"></b>
                                    </div>
                                </div>
                            </nav>
                            <div class="content-right">
                                <div class="frame-parent111">
                                    <div class="filter-bar-wrapper">
                                        <div class="filter-bar">
                                            <div class="image-filter">
                                                <img
                                                        class="image-4-icon2"
                                                        loading="lazy"
                                                        alt=""
                                                        src="/images/image-4@2x.png"
                                                />

                                                <div class="image-filter-inner">
                                                    <div class="rectangle-parent102">
                                                        <div class="frame-child128"></div>
                                                        <div class="div193">А/Я</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="filter-name">
                                                <h3 class="h34">Панель фильтрации</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="component-19-parent">
                                        <ul class="component-191" id="testList">
                                            <li class="frame-parent112" th:data-card-id="${scoring.id}" th:each="scoring : ${scorings}"
                                                th:attr="data-title=${scoring.title}, data-type=${scoring.type}, data-date=${#dates.format(scoring.getDate(), 'yyyy-MM-dd')}">
                                                <div class="rectangle-parent103">
                                                    <b th:text="${#dates.format(scoring.getDate(), 'dd.MM.yyyy')}" class="test-list-dividers">20.02.2024</b>
                                                    <div class="frame-child129"></div>
                                                </div>
                                                <div class="test-list-names">
                                                    <div class="test-list-names-child"></div>
                                                    <h2 class="h23" th:text="${scoring.title}"></h2>
                                                    <div class="test-list-icons">
                                                        <button class="rectangle-parent104" th:data-card-id="${scoring.id}" onclick="goTo(this)">
                                                            <div class="frame-child130"></div>
                                                            <b class="oprosnik" th:if="${scoring.type == T(ru.sfedu.simplepsyspecialist.entity.nested.TypeOfScoring).QUESTIONER}">
                                                                Опросник
                                                            </b>
                                                            <b class="b121" th:if="${scoring.type == T(ru.sfedu.simplepsyspecialist.entity.nested.TypeOfScoring).TEST}">
                                                                Тест
                                                            </b>
                                                        </button>
                                                        <button class="copy-button" th:data-scoring-id="${scoring.id}" onclick="openCopyLinkModal(this)">
                                                            <b class="copy-button-text">Копировать ссылку</b>
                                                        </button>
                                                    </div>
                                                </div>
                                            </li>
                                        </ul>
                                        <form class="search-bar-container-parent" id="searchForm">
                                            <div class="search-bar-container">
                                                <div class="search-bar-container-inner">
                                                    <div class="rectangle-parent117">
                                                        <div class="frame-child143"></div>
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon141">
                                                            <path d="M 10 2 C 5.589844 2 2 5.589844 2 10 C 2 14.410156 5.589844 18 10 18 C 11.785156 18 13.433594 17.40625 14.734375 16.40625 L 19.292969 20.96875 L 20.707031 19.554688 L 16.144531 14.996094 C 17.144531 13.695312 17.738281 12.046875 17.738281 10.261719 C 17.738281 5.589844 14.410156 2 10 2 Z M 10 4 C 13.300781 4 16 6.699219 16 10 C 16 13.300781 13.300781 16 10 16 C 6.699219 16 4 13.300781 4 10 C 4 6.699219 6.699219 4 10 4 Z" fill="silver"/>
                                                        </svg>
                                                        <input class="search-input-area" placeholder="Поиск" type="text" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="my-materials-container">
                                                <button
                                                        class="rectangle-parent120"
                                                        id="groupButton6"
                                                        onclick="window.location.href='/SimplePsy/V1/scoring/test/creation';">
                                                    <div class="frame-child146"></div>

                                                    <div class="div200">
                                                        Перейти к моим материалам
                                                    </div>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="item106">
        <img class="feather-icon-chevron-up18" alt="" />
    </div>

</div>
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div id="modal-body"></div>
    </div>
</div>
<script defer>
    var copyLinkBtn = document.querySelector('.copy-button');

    copyLinkBtn.addEventListener('click', openCopyLinkModal);
    function openCopyLinkModal(buttonElement) {
        const scoringId = buttonElement.getAttribute("data-scoring-id");
        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body");

        // Загружаем HTML для модального окна
        fetch('/SimplePsy/V1/scoring/test/copy-link')
            .then(response => response.text())
            .then(data => {
                modalBody.innerHTML = data;
                modal.style.display = 'block'; // Открываем модальное окно
            })
            .catch(error => console.error('Ошибка загрузки:', error));

        // Загружаем список клиентов и добавляем необходимые обработчики событий
        fetch('/SimplePsy/V1/customer/findAll')
            .then(response => response.json())
            .then(clients => {
                const dataList = document.getElementById('clientsList');
                dataList.innerHTML = '';

                clients.forEach(customer => {
                    const option = document.createElement('option');
                    switch (customer.typeOfClient) {
                        case 'ADULT':
                            option.value = customer.name + ' ' +customer.surname;
                            break;
                        case 'CHILD':
                            option.value = customer.childName + ' ' + customer.childSurname;
                            break;
                        case 'COUPLE':
                            option.value = customer.firstClientName + ' ' + customer.firstClientSurname;
                            break;
                        default:
                            // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                            console.log('Unknown client type');
                            break;
                    }
                    option.setAttribute('data-id', customer.id);
                    dataList.appendChild(option);
                });

                // Установка текущего теста
                currentTestId = scoringId;

                // Обработчик изменения в поле выбора клиента
                document.getElementById('clientInput').addEventListener('input', function() {
                    const selectedOption = Array.from(document.getElementById('clientsList').options)
                        .find(option => option.value === this.value);
                    if (selectedOption) {
                        const clientId = selectedOption.getAttribute('data-id');
                        document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
                        if (!clientId || !currentTestId) {

                            alert("Пожалуйста, выберите клиента и тест.");
                            return;
                        }
                        let uri = `http://93.95.97.176:8081/SimplePsy/V1/scoring/test/${currentTestId}/${clientId}`;
                        console.log("ClientId has been changed");
                        console.log(uri)
                        document.getElementById('inputField').value = uri;
                    } else {
                        document.getElementById('clientId').value = ''; // Очищаем скрытое поле, если клиент не найден
                        document.getElementById('inputField').value = '';
                    }
                });

                // Обработка кнопки копирования ссылки
                document.querySelector('.copy-btn').addEventListener('click', function() {
                    var inputField = document.getElementById("inputField");
                    if (inputField.value === '') {
                        alert("Поле копирования пустое");
                    } else {
                        inputField.select();
                        inputField.setSelectionRange(0, 99999);
                        document.execCommand("copy");
                        alert("Ссылка скопирована в буфер обмена");
                    }
                });
            })
            .catch(error => console.error('Ошибка:', error));
    }

    function goTo(obj) {
        window.location.href = "/SimplePsy/V1/scoring/test/edit/" + obj.getAttribute("data-card-id");
    }
    let buttons = document.querySelectorAll('.item103, .item104, .item105');

    buttons.forEach(button => {
      button.addEventListener('click', function(event) {
          // Удаляем класс active у всех кнопок
          buttons.forEach(btn => btn.classList.remove('active'));

          // Добавляем класс active к нажатой кнопке
          this.classList.add('active');

          // Предотвращаем потерю фокуса после клика
          event.preventDefault();
          this.blur(); // Сбрасываем фокус
      });
    });

    // document.addEventListener('DOMContentLoaded', function() {
    // const dateInput = document.querySelector('.xxxxxxxx');
    //
    // dateInput.addEventListener('input', function(e) {
    //   let value = e.target.value.replace(/[^0-9]/g, ''); // Удаляем все символы, кроме цифр
    //
    //   if (e.inputType === 'deleteContentBackward') {
    //       // Если это действие удаления, то не вставляем точки
    //       return;
    //   }
    //
    //   // Форматируем значение в формат dd.mm.yyyy
    //   if (value.length >= 2 && value.length <= 4) {
    //       value = value.replace(/^(\d{2})(\d{0,2})/, '$1.$2');
    //   } else if (value.length > 4) {
    //       value = value.replace(/^(\d{2})(\d{2})(\d{0,4})/, '$1.$2.$3');
    //   }
    //
    //   e.target.value = value;
    // });
    //
    // dateInput.addEventListener('keydown', function(e) {
    //   // Разрешаем удаление точек при нажатии Backspace
    //   if (e.key === 'Backspace' && this.value.endsWith('.')) {
    //       this.value = this.value.slice(0, -1);
    //   }
    // });
    // });
        // const dateInput = document.querySelector('.xxxxxxxx1');
        //
        // dateInput.addEventListener('input', function(e) {
        //   let value = e.target.value.replace(/[^0-9]/g, ''); // Удаляем все символы, кроме цифр
        //
        //   if (e.inputType === 'deleteContentBackward') {
        //       // Если это действие удаления, то не вставляем точки
        //       return;
        //   }
        //
        //   // Форматируем значение в формат dd.mm.yyyy
        //   if (value.length >= 2 && value.length <= 4) {
        //       value = value.replace(/^(\d{2})(\d{0,2})/, '$1.$2');
        //   } else if (value.length > 4) {
        //       value = value.replace(/^(\d{2})(\d{2})(\d{0,4})/, '$1.$2.$3');
        //   }
        //
        //   e.target.value = value;
        // });
        //
        // dateInput.addEventListener('keydown', function(e) {
        //   // Разрешаем удаление точек при нажатии Backspace
        //   if (e.key === 'Backspace' && this.value.endsWith('.')) {
        //       this.value = this.value.slice(0, -1);
        //   }
        // });

        document.getElementById('searchForm').addEventListener('submit', function (event) {
            event.preventDefault();

            // Получение значений из формы
            const searchQuery = document.querySelector('.search-input-area').value.toLowerCase();
            const selectedType = document.querySelector('.component17 .item104.active')?.innerText.toLowerCase();
            //const startDate = document.querySelector('.xxxxxxxx').value;
            //const endDate = document.querySelector('.xxxxxxxx1').value;

            // Преобразование дат в формат YYYY-MM-DD
            const parseDate = (dateStr) => {
                const [day, month, year] = dateStr.split('.');
                return `${year}-${month}-${day}`;
            };

            const listItems = document.querySelectorAll('#testList li');

            listItems.forEach(item => {
                const title = item.getAttribute('data-title').toLowerCase();
                const type = item.getAttribute('data-type').toLowerCase();
                const date = item.getAttribute('data-date');

                let matchesSearch = title.includes(searchQuery);
                let matchesType = !selectedType || type === selectedType;
                let matchesDate = (!startDate || date >= parseDate(startDate)) && (!endDate || date <= parseDate(endDate));

                if (matchesSearch && matchesType && matchesDate) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        const searchInput = document.querySelector('.search-input-area');

        searchInput.addEventListener('input', function () {
            const query = searchInput.value.toLowerCase();

            const listItems = document.querySelectorAll('#testList li');

            listItems.forEach(item => {
                const title = item.getAttribute('data-title').toLowerCase();

                // Check if the title includes the search query
                if (title.includes(query)) {
                    item.style.display = ''; // Show the item
                } else {
                    item.style.display = 'none'; // Hide the item
                }
            });
        });
        buttons = document.querySelectorAll('.item104, .item105');

        buttons.forEach(button => {
            button.addEventListener('click', function () {
                // Удаляем активный класс со всех кнопок
                buttons.forEach(btn => btn.classList.remove('active'));

                // Добавляем активный класс на текущую кнопку
                this.classList.add('active');

                // Получаем тип (опрос или тест) из кнопки
                const selectedType = this.innerText.toLowerCase();

                // Фильтрация списка
                listItems.forEach(item => {
                    const itemType = item.getAttribute('data-type').toLowerCase();
                    if (itemType === selectedType) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });

            document.getElementById('searchForm').addEventListener('submit', function (event) {
                event.preventDefault();

                const searchQuery = document.querySelector('.search-input-area').value.toLowerCase();
                //const startDate = document.querySelector('.xxxxxxxx').value;
                //const endDate = document.querySelector('.xxxxxxxx1').value;

                const parseDate = (dateStr) => {
                    const [day, month, year] = dateStr.split('.');
                    return new Date(`${year}-${month}-${day}`);
                };

                //const start = startDate ? parseDate(startDate) : null;
                // const end = endDate ? parseDate(endDate) : null;

                listItems.forEach(item => {
                    const itemTitle = item.getAttribute('data-title').toLowerCase();
                    const itemDate = new Date(item.getAttribute('data-date'));

                    let matchesQuery = itemTitle.includes(searchQuery);
                    let matchesDate = true;

                    // if (start && end) {
                    //     matchesDate = itemDate >= start && itemDate <= end;
                    // } else if (start) {
                    //     matchesDate = itemDate >= start;
                    // } else if (end) {
                    //     matchesDate = itemDate <= end;
                    // }

                    if (matchesQuery && matchesDate) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });

        // Получаем элементы
        var modal = document.getElementById('modal');
        var modalBody = document.getElementById('modal-body');
        var closeBtn = document.querySelector('.close-btn');
        var appointLink = document.querySelector('.news10'); // Элемент "Назначить встречу"
        var holidayBtn = document.querySelector('.user-policy11');


        // Функция для открытия модального окна
        function openModal() {
            fetch('/SimplePsy/V1/session/session-form')
                .then(response => response.text())
                .then(data => {
                    modalBody.innerHTML = data;
                    modal.style.display = 'block';
                })
                .catch(error => console.error('Ошибка загрузки:', error));

            fetch('/SimplePsy/V1/customer/findAll')
                .then(response => response.json())
                .then(clients => {
                    const dataList = document.getElementById('clientsList');
                    dataList.innerHTML = '';

                    clients.forEach(customer => {
                        const option = document.createElement('option');
                        switch (customer.typeOfClient) {
                            case 'ADULT':
                                option.value = customer.name + ' ' +customer.surname;
                                break;
                            case 'CHILD':
                                option.value = customer.childName + ' ' + customer.childSurname;
                                break;
                            case 'COUPLE':
                                option.value = customer.firstClientName + ' ' + customer.firstClientSurname;
                                break;
                            default:
                                // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                                console.log('Unknown client type');
                                break;
                        }
                        option.setAttribute('data-id', customer.id);
                        dataList.appendChild(option);
                    });
                })
                .catch(error => console.error('Ошибка:', error));

            const script = document.createElement('script');
            script.id = 'dynamic-script';
            script.textContent = `
               document.getElementById('clientInput').addEventListener('change', function() {
    const selectedOption = Array.from(document.getElementById('clientsList').options)
            .find(option => option.value === this.value);
    if (selectedOption) {
      const clientId = selectedOption.getAttribute('data-id');
      document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
      document.getElementById('error-message').style.display = 'none'; // Скрываем сообщение об ошибке при успешном выборе клиента
    } else {
      document.getElementById('clientId').value = ''; // Очищаем скрытое поле, если выбранного клиента нет в списке
    }
  });`;
            document.body.appendChild(script);
        }

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = 'none';
        }

        function openHolidayModal() {

            fetch('/SimplePsy/V1/session/holiday')
                .then(response => response.text())
                .then(html => {
                    modalBody.innerHTML = html;
                    modal.style.display = "block";

                    // Добавляем обработчик закрытия модального окна
                    document.querySelector('.close-modal').onclick = function () {
                        modal.style.display = "none";
                    };
                })
                .catch(error => {
                    console.error('Error loading modal content:', error);
                });
        }

        appointLink.addEventListener('click', openModal);
        holidayBtn.addEventListener('click', openHolidayModal);
        closeBtn.addEventListener('click', closeModal);

        var addClientBtn = document.querySelector('.about-us17');
        addClientBtn.addEventListener('click', () => {
            window.location.href = '/SimplePsy/V1/customer/customer-form';
        });

        // Закрытие модального окна
        document.querySelector('.close-btn').onclick = function () {
            document.getElementById('modal').style.display = 'none';
        };

        // Генерация ссылки
        function generateLink(testId, clientId) {
            const link = `/SimplePsy/V1/scoring/test/${testId}/${clientId}`;
            document.getElementById('generatedLink').value = link;
        }

        // Валидация формы перед копированием ссылки
        function validateForm() {
            const clientId = document.getElementById('clientId').value;
            if (!clientId) {
                document.getElementById('error-message').style.display = 'block'; // Показываем сообщение об ошибке
                return false; // Отменяем отправку формы
            }
            navigator.clipboard.writeText(document.getElementById('generatedLink').value);
            document.getElementById('modal').style.display = 'none'; // Закрытие модального окна
            return true; // Разрешаем отправку формы
        }

        // Закрытие модального окна при нажатии вне его
        window.onclick = function (event) {
            if (event.target == document.getElementById('modal')) {
                document.getElementById('modal').style.display = 'none';
            }
        }
</script>
</body>
</html>
