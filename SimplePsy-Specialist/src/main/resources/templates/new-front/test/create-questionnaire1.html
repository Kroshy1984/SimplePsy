<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width" />

  <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/global.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/default-page.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/test/create-questionnaire1.css}" />
  <link
          rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap"
  />
  <link
          rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Rubik:wght@400&display=swap"
  />
</head>
<body>
<div class="div139">
  <div class="sidebar1">
    <div class="menu">
      <div class="frame-wrapper73">
        <div class="frame-parent122">
          <div class="frame-parent123">
            <div class="client-list-wrapper">
              <button class="base90" onclick="window.location.href='/SimplePsy/V1/specialist/customers';"></button>
              <div class="icon-wrapper33">
                <img class="icon146" alt="" src="/images/icon-3@2x.png" />
              </div>
              <b class="client-list">Список клиентов</b>
            </div>
            <div class="base-frame">
              <button class="calendar-wrapper" id="baseContainer" onclick="window.location.href='/SimplePsy/V1/session/calendar';">
                <div class="icon-wrapper34">
                  <img class="icon147" alt="" src="/images/icon-41@2x.png"/>
                </div>
                <b class="calendar">Календарь</b>
              </button>
            </div>
          </div>
          <div class="frame-parent123">
            <div class="notifications-wrapper">
              <button class="base90 fix-angle-base90" onclick="alert('Эта кнопка находится в разработке')"></button>
              <div class="icon-wrapper33">
                <img class="icon146" alt="" src="/images/icon-5.svg" />
              </div>
              <b class="notifications">Уведомления</b>
            </div>
            <div class="base-frame">
              <button class="calendar-wrapper" id="baseContainer" onclick="alert('Эта кнопка находится в разработке')">
                <div class="icon-wrapper34">
                  <img class="icon147" alt="" src="/images/icon-6.svg"/>
                </div>
                <b class="analytics">Аналитика</b>
              </button>
            </div>
            <div class="tests-wrapper">
              <button class="base94" onclick="window.location.href='/SimplePsy/V1/scoring/list';"></button>
              <b class="surveys-tests">Опросники и тесты</b>
            </div>
          </div>
        </div>
      </div>
      <div class="parent26">
        <b class="b112">Заявки</b>
        <div class="rectangle-parent87" id="groupContainer">
          <div class="frame-child111"></div>
          <div class="frame-child112"></div>
          <b class="b113">Овсянникова Юля Матвеевна</b>
          <b class="b114">20.02.2024</b>
        </div>
        <div class="rectangle-parent88" id="groupContainer1">
          <div class="frame-child113"></div>
          <div class="frame-child114"></div>
          <b class="b115">Овсянникова Кирилл Матвеев</b>
          <b class="b116">25.02.2024</b>
        </div>
      </div>
    </div>
    <div class="feedback-item">
      <div class="feedback-button">
        <img
                class="icon30"
                loading="lazy"
                alt=""
                src="/images/icon-7@2x.png"
        />

        <div class="frame-parent13" onclick="alert('Эта кнопка находится в разработке')">
          <div class="send-feedback-container">
            <b class="send-feedback1">Обратная связь</b>
          </div>
          <img
                  class="icon31"
                  loading="lazy"
                  alt=""
                  src="/images/icon-8.svg"
          />
        </div>
      </div>
    </div>

    <div class="head">
      <div class="wrapper-user8">
        <img
                class="user-icon"
                loading="lazy"
                alt=""
                th:src="@{'/SimplePsy/V1/specialist/avatar/' + ${specialist.id}}"
                id="userImage"
                onclick="window.location.href='/SimplePsy/V1/specialist/personal-info'"
        />
      </div>
      <div class="frame-parent50">
        <div class="hello-wrapper">
          <b class="hello">Привет, </b>
          <b th:text="${specialist.name}" class="hello" ></b>
          <b class="hello">!</b>
        </div>
        <b class="specialist-email">
          <p th:text="${specialist.username}" class="specialist-email-content"></p>
        </b>
      </div>
    </div>
  </div>
  <header class="head1">
    <div class="navigate">
      <a class="constructor8" href="/SimplePsy/V1/session/calendar">Понятная практика</a>
      <div class="menu1">
        <b class="about-us15" id="aboutUsText">Добавить клиента</b>
        <b class="news10" id="newsText">Назначить встречу</b>
        <b class="user-policy9" id="userPolicyText">Добавить график нерабочих дней</b>
      </div>
      <input type="hidden" id="currentSpecialistId" th:value="${specialist.id}">
      <div class="search8">
        <input type="text" class="search1" placeholder="Найти клиента..." list="customerList" id="customerSearch" autocomplete="off">
        <datalist id="customerList">

        </datalist>
        <img
                class="icon121"
                loading="lazy"
                alt=""
                src="/images/icon-1@2x.png"
        />
      </div>
      <div class="city">
        <img
                class="icon122"
                loading="lazy"
                alt=""
                src="/images/icon-2@2x.png"
        />
        <b th:text="${specialist.city}" class="specialist-city"></b>
      </div>
      <img
              class="icon123"
              loading="lazy"
              alt=""
              src="/images/icon@2x.png"
      />
    </div>
  </header>
  <div class="create-test-content">
    <div class="create-test-header">
      <div class="create-test-type">
        <div class="create-test-type-content">
          <div class="create-test-type-content-inner">
            <div class="rectangle-parent173">
              <div class="frame-child207"></div>
              <h3 class="h38">Опросы</h3>
            </div>
          </div>
          <button class="rectangle-parent172" type="button" onclick="window.location.href='/SimplePsy/V1/scoring/test/creation';">
            <div class="frame-child206"></div>
            <div class="div342">Тесты</div>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="survey-container">
    <h2>Создать опрос</h2>
    <form id="surveyForm" th:action="@{/SimplePsy/V1/scoring/creation}">
      <input type="text" id="surveyTitle" name="title" placeholder="Введите название опроса" required>
      <div id="questionsContainer"></div>

      <button type="button" class="add-question-button" onclick="addQuestion()">Добавить вопрос</button>
      <button type="submit">Создать опрос</button>
    </form>
  </div>
</div>
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>
<script>
  function addOption(questionId) {
    const optionsContainer = document.getElementById(`optionsContainer-${questionId}`);
    const newOption = document.createElement("div");
    newOption.className = "survey-option";
    newOption.innerHTML = `
        <input type="radio" name="option-${questionId}" disabled>
        <input type="text" name="optionText-${questionId}" placeholder="Вариант ответа" required>
      `;
    optionsContainer.appendChild(newOption);
  }

  function addQuestion() {
    const questionsContainer = document.getElementById("questionsContainer");
    const questionId = `question-${questionsContainer.children.length + 1}`;
    const newQuestion = document.createElement("div");
    newQuestion.className = "survey-question";
    newQuestion.id = questionId;
    newQuestion.innerHTML = `
        <label for="${questionId}">Вопрос:</label>
        <input type="text" id="${questionId}" name="questionText" required>
        <div id="optionsContainer-${questionId}">
          <div class="survey-option">
            <input type="radio" name="option-${questionId}" disabled>
            <input type="text" name="optionText-${questionId}" placeholder="Вариант ответа" required>
          </div>
        </div>
        <button type="button" class="add-option-button" onclick="addOption('${questionId}')">Добавить вариант ответа</button>
      `;
    questionsContainer.appendChild(newQuestion);
  }

  document.getElementById("surveyForm").addEventListener("submit", function(event) {
    event.preventDefault();
    const title = document.getElementById("surveyTitle").value;
    const questions = Array.from(document.querySelectorAll(".survey-question")).map(question => {
      const questionText = question.querySelector("input[name='questionText']").value;
      const options = Array.from(question.querySelectorAll("input[name^='optionText']")).map(option => option.value);
      return { questionText, options };
    });
    fetch('/SimplePsy/V1/scoring/creation', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({title, questions }),
    })
            .then(response => response.json())
            .then(data => {
              console.log('Survey created:', data);
              window.location.href="/SimplePsy/V1/scoring/list";
            })
            .catch(error => {
              console.error('Error:', error);
            });
  });
  // Открытие модального окна создания сессии
  document.addEventListener('DOMContentLoaded', function() {
  // Получаем элементы
  var modal = document.getElementById('modal');
  var modalBody = document.getElementById('modal-body');
  var closeBtn = document.querySelector('.close-btn');
  var appointLink = document.querySelector('.news10'); // Элемент "Назначить встречу"
  var holidayBtn = document.querySelector('.user-policy9');

  // Функция для открытия модального окна
    function openModal() {
      fetch('/SimplePsy/V1/session/session-form')
              .then(response => response.text())
              .then(data => {
                modalBody.innerHTML = data;
                modal.style.display = 'block';
              })
              .catch(error => console.error('Ошибка загрузки:', error));

      fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
              .then(response => response.json())
              .then(clients => {
                const dataList = document.getElementById('clientsList');
                dataList.innerHTML = '';

                clients.forEach(customer => {
                  const option = document.createElement('option');
                  switch (customer.typeOfClient) {
                    case 'ADULT':
                      option.value = customer.name + ' ' +customer.surname;
                      break;
                    case 'CHILD':
                      option.value = customer.childName + ' ' + customer.childSurname;
                      break;
                    case 'COUPLE':
                      option.value = customer.firstClientName + ' ' + customer.firstClientSurname;
                      break;
                    default:
                      // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                      console.log('Unknown client type');
                      break;
                  }
                  option.setAttribute('data-id', customer.id);
                  dataList.appendChild(option);
                });
              })
              .catch(error => console.error('Ошибка:', error));

      const script = document.createElement('script');
      script.id = 'dynamic-script';
      script.textContent = `
                   document.getElementById('clientInput').addEventListener('change', function() {
        const selectedOption = Array.from(document.getElementById('clientsList').options)
                .find(option => option.value === this.value);
        if (selectedOption) {
          const clientId = selectedOption.getAttribute('data-id');
          document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
          document.getElementById('error-message').style.display = 'none'; // Скрываем сообщение об ошибке при успешном выборе клиента
        } else {
          document.getElementById('clientId').value = ''; // Очищаем скрытое поле, если выбранного клиента нет в списке
        }
      });`;
      document.body.appendChild(script);
    }

    // Функция для закрытия модального окна
    function closeModal() {
      modal.style.display = 'none';
      const script = document.getElementById('dynamic-script');
      if (script) {
        script.remove();
        console.log('Скрипт удалён');
      } else {
        console.log('Скрипт не найден');
      }
    }

    function openHolidayModal() {
      const modal = document.getElementById("modal");
      const modalBody = document.getElementById("modal-body");

      fetch('/SimplePsy/V1/session/holiday')
              .then(response => response.text())
              .then(html => {
                modalBody.innerHTML = html;
                modal.style.display = "block";

                // Добавляем обработчик закрытия модального окна
                document.querySelector('.close-modal').onclick = function () {
                  modal.style.display = "none";
                };
              })
              .catch(error => {
                console.error('Error loading modal content:', error);
              });
    }

  // Событие клика для открытия модального окна
  appointLink.addEventListener('click', openModal);
  holidayBtn.addEventListener('click', openHolidayModal);
  // Событие клика для закрытия модального окна
  closeBtn.addEventListener('click', closeModal);
  });

  var  addClientBtn = document.querySelector('.about-us15');
  addClientBtn.addEventListener('click', () =>
  {
    window.location.href = '/SimplePsy/V1/customer/customer-form';
  });
  const customerSearch = document.getElementById('customerSearch');
  const currentSpecialistId = document.getElementById('currentSpecialistId').value;

  customerSearch.addEventListener('input', function () {
    const searchQuery = this.value;
    const datalist = document.getElementById('customerList');

    if (searchQuery.length > 1) { // Минимум 2 символа для отправки запроса
      fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
              .then(response => response.json())
              .then(data => {
                // Очищаем предыдущие результаты
                datalist.innerHTML = '';

                // Фильтруем и сортируем клиентов в зависимости от типа
                data.forEach(customer => {
                  let displayName = '';
                  if (customer.typeOfClient === 'ADULT') {
                    displayName = `${customer.name} ${customer.surname}`;
                  } else if (customer.typeOfClient === 'CHILD') {
                    displayName = `${customer.childName} ${customer.childSurname}`;
                  } else if (customer.typeOfClient === 'COUPLE') {
                    displayName = `${customer.firstClientName} ${customer.firstClientSurname}`;
                  }

                  if (displayName.toLowerCase().includes(searchQuery.toLowerCase())) {
                    const option = document.createElement('option');
                    option.value = displayName;
                    option.dataset.id = customer.id;
                    datalist.appendChild(option);
                  }
                });
              })
              .catch(error => {
                console.error('Ошибка при загрузке данных клиентов:', error);
              });
    }
  });

  customerSearch.addEventListener('change', function () {
    const selectedOption = Array.from(document.querySelectorAll('#customerList option'))
            .find(option => option.value === customerSearch.value);

    if (selectedOption) {
      const customerId = selectedOption.dataset.id;
      window.location.href = `/SimplePsy/V1/customer/customer-card/${customerId}`; // Передача username через GET-параметр
    }
  });
</script>
</body>
</html>
