<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/global.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/default-page.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/test/questionnaire.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/new-front/calendar/calendar.css}" />
    <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap"
    />
    <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Rubik:wght@400&display=swap"
    />
</head>
<body>
<div class="frame-wrapper6">
    <div class="frame-parent7">
        <div class="icon-parent2">
            <img
                    class="icon23"
                    loading="lazy"
                    alt=""
                    src="/images/icon@2x.png"
            />

            <div class="constructor-wrapper">
                <a class="constructor1" href="/SimplePsy/V1/session/calendar">Понятная практика</a>
            </div>
            <div class="icon-parent3">
                <img
                        class="icon24"
                        loading="lazy"
                        alt=""
                        src="/images/icon-1@2x.png"
                />
                <input type="hidden" id="currentSpecialistId" th:value="${specialist.id}">
                <div class="search-input">
                    <input type="text" class="search1" placeholder="Найти клиента..." list="customerList" id="customerSearch" autocomplete="off">
                    <datalist id="customerList">

                    </datalist>

                </div>
            </div>
        </div>
        <div class="main-area-inner">
            <div class="about-us-parent4">
                <a class="about-us16">Добавить клиента</a>
                <a class="news10">Назначить встречу</a>
                <a class="user-policy10">Добавить график нерабочих дней </a>
            </div>
        </div>
    </div>
</div>
<div class="div139">
<div class="sidebar1 sidebar1-fix-width">
    <div class="menu">
        <div class="frame-wrapper73">
            <div class="frame-parent122">
                <div class="frame-parent123">
                    <div class="client-list-wrapper">
                        <button class="base90" onclick="window.location.href='/SimplePsy/V1/specialist/customers';"></button>
                        <div class="icon-wrapper33">
                            <img class="icon146" alt="" src="/images/icon-3@2x.png" />
                        </div>
                        <b class="client-list">Список клиентов</b>
                    </div>
                    <div class="base-frame">
                        <button class="calendar-wrapper" id="baseContainer" onclick="window.location.href='/SimplePsy/V1/session/calendar';">
                            <div class="icon-wrapper34">
                                <img class="icon147" alt="" src="/images/icon-41@2x.png"/>
                            </div>
                            <b class="calendar">Календарь</b>
                        </button>
                    </div>
                </div>
                <div class="frame-parent123">
                    <div class="notifications-wrapper">
                        <button class="base90 fix-angle-base90" onclick="alert('Эта кнопка находится в разработке')"></button>
                        <div class="icon-wrapper33">
                            <img class="icon146" alt="" src="/images/icon-5.svg" />
                        </div>
                        <b class="notifications">Уведомления</b>
                    </div>
                    <div class="base-frame">
                        <button class="calendar-wrapper" id="baseContainer" onclick="alert('Эта кнопка находится в разработке')">
                            <div class="icon-wrapper34">
                                <img class="icon147" alt="" src="/images/icon-6.svg"/>
                            </div>
                            <b class="analytics">Аналитика</b>
                        </button>
                    </div>
                    <div class="tests-wrapper">
                        <button class="base94" onclick="window.location.href='/SimplePsy/V1/scoring/list';"></button>
                        <b class="surveys-tests">Опросники и тесты</b>
                    </div>
                </div>
            </div>
        </div>
        <div class="parent26">
            <b class="b112">Заявки</b>
            <div class="rectangle-parent87" id="groupContainer">
                <div class="frame-child111"></div>
                <div class="frame-child112"></div>
                <b class="b113">Овсянникова Юля Матвеевна</b>
                <b class="b114">20.02.2024</b>
            </div>
            <div class="rectangle-parent88" id="groupContainer1">
                <div class="frame-child113"></div>
                <div class="frame-child114"></div>
                <b class="b115">Овсянникова Кирилл Матвеев</b>
                <b class="b116">25.02.2024</b>
            </div>
        </div>
    </div>
    <div class="feedback3">
        <b class="send-feedback8">Обратная связь</b>
        <img
                class="icon119"
                loading="lazy"
                alt=""
                src="/images/icon-7@2x.png"
        />

        <img
                class="icon120"
                loading="lazy"
                alt=""
                src="/images/icon-8.svg"
        />
    </div>

    <div class="head">
        <div class="wrapper-user8">
            <img
                    class="user-icon8"
                    loading="lazy"
                    alt=""
                    src="/images/user@2x.png"
                    id="userImage"
                    onclick="window.location.href='/SimplePsy/V1/specialist/personal-info'"
            />
        </div>
        <b class="hello-rosalie8">Привет, Антон!</b>
        <b class="rosaliericegmailc8">rosalie.rice@gmail.com</b>
    </div>
</div>
<header class="head1">
    <div class="navigate">
        <a class="constructor8">Понятная практика</a>
        <div class="menu1">
            <a class="news10">Назначить встречу</a>
            <b class="user-policy9" id="userPolicyText"
            >Добавить график нерабочих дней
            </b>
            <b class="about-us15" id="aboutUsText">Добавить клиента</b>
        </div>
        <div class="search8">
            <b class="search9">Найти клиента...</b>
            <img
                    class="icon121"
                    loading="lazy"
                    alt=""
                    src="/images/icon-1@2x.png"
            />
        </div>
        <div class="city">
            <b class="new-york8">Ростов-на-Дону</b>
            <img
                    class="icon122"
                    loading="lazy"
                    alt=""
                    src="/images/icon-2@2x.png"
            />
        </div>
        <img
                class="icon123"
                loading="lazy"
                alt=""
                src="/images/icon@2x.png"
        />
    </div>

</header>

<div class="survey-container">
    <h2>Скоринги</h2>
    <input type="hidden" th:value="${customerId}" id="customerId">
    <div th:each="completedScoring:${completedScorings}">
        <button class="rectangle-parent104" th:data-card-id="${completedScoring.id}" onclick="goTo(this)">ответы</button>
        <b th:text="${completedScoring.title}"></b>
    </div>
</div>
</div>
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <div id="modal-body"></div>
    </div>
</div>

</body>
<script>
    function goTo(obj) {
        window.location.href = "/SimplePsy/V1/scoring/scoring/" + document.getElementById('customerId').value + "/" + obj.getAttribute("data-card-id");
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Получаем элементы
        var modal = document.getElementById('modal');
        var modalBody = document.getElementById('modal-body');
        var closeBtn = document.querySelector('.close-btn');
        var appointLink = document.querySelector('.news10'); // Элемент "Назначить встречу"
        var holidayBtn = document.querySelector('.user-policy10');

        // Функция для открытия модального окна
        function openModal() {
            fetch('/SimplePsy/V1/session/session-form')
                .then(response => response.text())
                .then(data => {
                    modalBody.innerHTML = data;
                    modal.style.display = 'block';
                })
                .catch(error => console.error('Ошибка загрузки:', error));

            fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
                .then(response => response.json())
                .then(clients => {
                    const dataList = document.getElementById('clientsList');
                    dataList.innerHTML = '';

                    const script = document.createElement('script');
                    script.id = 'dynamic-script';
                    script.textContent = `
  document.getElementById('clientInput').addEventListener('change', function() {
    const selectedOption = Array.from(document.getElementById('clientsList').options).find(option => option.value === this.value);
    if (selectedOption) {
      const clientId = selectedOption.getAttribute('data-id');
      document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
    }
  });
  // Функция для валидации формы
  function validateForm() {
    const clientId = document.getElementById('clientId').value;
    if (!clientId) {
      document.getElementById('error-message').style.display = 'block'; // Показываем сообщение об ошибке
      return false; // Отменяем отправку формы
    }
    return true; // Разрешаем отправку формы, если значение есть
  }

  document.getElementById('clientInput').addEventListener('change', function() {
    const selectedOption = Array.from(document.getElementById('clientsList').options)
            .find(option => option.value === this.value);
    if (selectedOption) {
      const clientId = selectedOption.getAttribute('data-id');
      document.getElementById('clientId').value = clientId; // устанавливаем значение скрытого поля
      document.getElementById('error-message').style.display = 'none'; // Скрываем сообщение об ошибке при успешном выборе клиента
    } else {
      document.getElementById('clientId').value = ''; // Очищаем скрытое поле, если выбранного клиента нет в списке
    }
  });`;
                    document.body.appendChild(script);
                    clients.forEach(customer => {
                        const option = document.createElement('option');
                        switch (customer.typeOfClient) {
                            case 'ADULT':
                                option.value = customer.name + ' ' + customer.surname;
                                break;
                            case 'CHILD':
                                option.value = customer.childName + ' ' + customer.childSurname;
                                break;
                            case 'COUPLE':
                                option.value = customer.firstClientName + ' ' + customer.firstClientSurname;
                                break;
                            default:
                                // Здесь можно добавить код для обработки случая, если ни одно из значений не совпало
                                console.log('Unknown client type');
                                break;
                        }
                        option.setAttribute('data-id', customer.id);
                        dataList.appendChild(option);
                    });
                })
                .catch(error => console.error('Ошибка:', error));


        }

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = 'none';
            const script = document.getElementById('dynamic-script');
            if (script) {
                script.remove();
                console.log('Скрипт удалён');
            } else {
                console.log('Скрипт не найден');
            }
        }

        appointLink.addEventListener('click', openModal);
        holidayBtn.addEventListener('click', openHolidayModal);

        var  addClientBtn = document.querySelector('.about-us16');
        addClientBtn.addEventListener('click', () =>
        {
            window.location.href = '/SimplePsy/V1/customer/customer-form';
        });

        closeBtn.addEventListener('click', closeModal);
    });

    function openHolidayModal()
    {
        const modal = document.getElementById("modal");
        const modalBody = document.getElementById("modal-body");

        fetch('/SimplePsy/V1/session/holiday')
            .then(response => response.text())
            .then(html => {
                modalBody.innerHTML = html;
                modal.style.display = "block";

                // Добавляем обработчик закрытия модального окна
                document.querySelector('.close-modal').onclick = function() {
                    modal.style.display = "none";
                };
            })
            .catch(error => {
                console.error('Error loading modal content:', error);
            });
    }
    const customerSearch = document.getElementById('customerSearch');
    const currentSpecialistId = document.getElementById('currentSpecialistId').value;

    customerSearch.addEventListener('input', function () {
        const searchQuery = this.value;
        const datalist = document.getElementById('customerList');

        if (searchQuery.length > 1) { // Минимум 2 символа для отправки запроса
            fetch(`/SimplePsy/V1/customer/findAll/${currentSpecialistId}`)
                .then(response => response.json())
                .then(data => {
                    // Очищаем предыдущие результаты
                    datalist.innerHTML = '';

                    // Фильтруем и сортируем клиентов в зависимости от типа
                    data.forEach(customer => {
                        let displayName = '';
                        if (customer.typeOfClient === 'ADULT') {
                            displayName = `${customer.name} ${customer.surname}`;
                        } else if (customer.typeOfClient === 'CHILD') {
                            displayName = `${customer.childName} ${customer.childSurname}`;
                        } else if (customer.typeOfClient === 'COUPLE') {
                            displayName = `${customer.firstClientName} ${customer.firstClientSurname}`;
                        }

                        if (displayName.toLowerCase().includes(searchQuery.toLowerCase())) {
                            const option = document.createElement('option');
                            option.value = displayName;
                            option.dataset.id = customer.id;
                            datalist.appendChild(option);
                        }
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке данных клиентов:', error);
                });
        }
    });

    customerSearch.addEventListener('change', function () {
        const selectedOption = Array.from(document.querySelectorAll('#customerList option'))
            .find(option => option.value === customerSearch.value);

        if (selectedOption) {
            const customerId = selectedOption.dataset.id;
            window.location.href = `/SimplePsy/V1/customer/customer-card/${customerId}`; // Передача username через GET-параметр
        }
    });
</script>
</html>